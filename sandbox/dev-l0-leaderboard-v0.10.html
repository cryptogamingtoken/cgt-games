<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>CGT ‚Ä¢ Dev L0 ‚Äî Leaderboard (Mock MVP) v0.10</title>
<style>
:root{
  --bg:#0b0f14; --ink:#eaf2ff; --muted:#9fb3cc;
  --panel:#101826; --line:#233247;
  --good:#57d39d; --bad:#ff6b6b; --warn:#59b0ff;
  --btn:#0f1724; --btn2:#152235; --accent:#6be9cd; --pill:#1a2433;
}
*{box-sizing:border-box} html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,#0b0f14,#0e141c);color:var(--ink);
     font:15px/1.45 ui-sans-serif,system-ui,-apple-system,Inter,"Segoe UI",Roboto,Arial}
header{position:sticky;top:0;z-index:5;padding:.8rem 1rem;background:rgba(11,15,20,.82);
       backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid #17202b}
.brand{font-weight:800}
main{max-width:980px;margin:0 auto;padding:1rem .9rem 5rem;display:grid;gap:1rem}
.row{display:flex;gap:.6rem;flex-wrap:wrap;align-items:center}
.pill{padding:.3rem .6rem;border:1px solid #26384f;border-radius:999px;background:var(--pill);color:var(--muted)}
.btn{appearance:none;border:1px solid #2a3c55;border-radius:12px;padding:.65rem .9rem;background:var(--btn);
     color:#fff;font-weight:700;cursor:pointer}
.btn.primary{background:linear-gradient(180deg,#19b7c8,#0ea1ad);border-color:#0a8692}
.btn.good{background:linear-gradient(180deg,#30c288,#279d70);border-color:#1f7c59}
.btn.bad{background:linear-gradient(180deg,#f46b6b,#c84d4d);border-color:#912f2f}
.btn:active{transform:translateY(1px)}
.card{border:1px solid #233247;border-radius:14px;background:#0f1623;padding:1rem}
.h2{font-weight:800;margin:.2rem 0 .4rem}
.h3{font-weight:800;margin:.2rem 0 .3rem;font-size:1.05rem}
.table{width:100%;border-collapse:collapse;font-size:.95rem}
.table th,.table td{border-bottom:1px solid #1e2b3e;padding:.55rem .5rem;text-align:left}
.table th{color:#a8bdd7;font-weight:800}
.flag.good{color:var(--good)} .flag.bad{color:var(--bad)} .flag.warn{color:var(--warn)}
.kv{display:grid;grid-template-columns:140px 1fr;gap:.35rem .6rem;color:#c8d5e8}
.kv .k{color:#9fb3cc}
.flex-b{display:flex;justify-content:space-between;align-items:center;gap:.6rem;flex-wrap:wrap}
.footerBar{position:sticky;bottom:0;z-index:4;padding:.7rem 1rem;border-top:1px solid #17202b;
  background:linear-gradient(180deg,#0b0f14 10%,#0c121a)}
.stage{background:linear-gradient(180deg,#162233,#101a27);border:1px solid #233247;border-radius:16px;
       box-shadow:0 20px 48px rgba(0,0,0,.45), inset 0 0 0 1px rgba(255,255,255,.03);padding:1rem}
.badge{display:inline-flex;align-items:center;gap:.35rem;padding:.3rem .55rem;border:1px dashed #2b3b52;border-radius:999px;color:#9fb3cc}
.small{font-size:.86rem}
.hr{height:1px;background:#1c2a3c;margin:.6rem 0}
.bigblood{font-weight:900;color:#fff;background:linear-gradient(180deg,#ee4b4b,#b61616);
  border:1px solid #7d0e0e;border-radius:12px;padding:.35rem .6rem;box-shadow:0 6px 16px rgba(178,21,21,.35)}
/* Layout */
.grid{display:grid;gap:1rem}
@media(min-width:880px){ .grid{grid-template-columns:1.2fr .8fr} }
/* Overlays */
.overlay{position:fixed;inset:0;background:rgba(6,8,12,.78);backdrop-filter:blur(6px);
         display:none;align-items:center;justify-content:center;z-index:30}
.dialog{background:#0f1623;border:1px solid #233247;border-radius:16px;max-width:620px;width:92%;
        padding:1rem 1rem 1.1rem;box-shadow:0 20px 50px rgba(0,0,0,.45)}
.dialog h3{margin:.1rem 0 .35rem}
.sub{color:var(--muted)}
/* Flash feedback */
.flash{
  position:fixed;inset:0;display:none;align-items:center;justify-content:center;z-index:50;
  font-size:18vw; line-height:1; text-shadow:0 6px 24px rgba(0,0,0,.5);
}
.flash.show{display:flex;animation:pop .6s ease}
@keyframes pop{0%{transform:scale(.8);opacity:.0}50%{transform:scale(1.05);opacity:1}100%{transform:scale(1);opacity:.0}}
</style>
</head>
<body>
<header>
  <div class="brand">üß© CGT ‚Ä¢ Dev L0 ‚Äî Leaderboard (Mock MVP) v0.10</div>
  <div class="row" style="margin-top:.35rem">
    <span class="pill">Blocks: <b id="blockNum">1</b>/3</span>
    <span class="pill">Cards: <b id="cardNum">0</b>/20</span>
    <span class="pill">Score: <b id="score">0</b></span>
    <span class="pill">Streak: <b id="streak">0</b></span>
    <span class="bigblood">Live Window: <b id="winTxt">‚Äî</b></span>
  </div>
</header>

<main id="app" class="grid" style="display:none">
  <!-- Leaderboard (top on mobile) -->
  <section class="card">
    <div class="flex-b">
      <div class="h2">Live Leaderboard (Top 5)</div>
      <span class="badge">Only accepted cards are listed</span>
    </div>
    <table class="table" id="lb">
      <thead><tr><th>#</th><th>Wallet</th><th>Score</th><th>Submitted</th><th>Flag</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Incoming card (bottom on mobile) -->
  <section class="card" id="incomingCard">
    <div class="h2">Incoming submission</div>
    <div class="kv">
      <div class="k">Tx</div><div id="txId">‚Äî</div>
      <div class="k">Wallet</div><div id="wallet">‚Äî</div>
      <div class="k">Score</div><div id="scoreIn">‚Äî</div>
      <div class="k">GQT</div><div id="gqtIn">‚Äî</div>
      <div class="k">Submitted</div><div id="timeIn">‚Äî</div>
    </div>
    <div class="hr"></div>
    <div class="flex-b">
      <button class="btn good" id="btnAccept">‚úîÔ∏é Current Block</button>
      <button class="btn bad" id="btnReject">‚úñÔ∏é Reject</button>
    </div>
    <div class="small" style="margin-top:.6rem;color:#9fb3cc">
      Goal: keep the leaderboard <b>clean</b>. Only accept cards that pass all checks.
    </div>
  </section>
</main>

<!-- Footer controls -->
<div class="footerBar">
  <div class="row" style="justify-content:space-between">
    <div class="row">
      <button class="btn" id="restart">‚Üª Start Again</button>
      <button class="btn" id="exportBtn">üì§ Export run</button>
    </div>
    <div class="row">
      <button class="btn" id="musicBtn">Music: On</button>
      <button class="btn" id="sfxBtn">SFX: On</button>
    </div>
  </div>
</div>

<!-- Overlays -->
<div class="overlay" id="introOv">
  <div class="dialog">
    <h3>CGT ‚Ä¢ Dev L0 ‚Äî Leaderboard (Mock MVP)</h3>
    <p class="sub" style="margin:.35rem 0 .7rem">
      <b>You‚Äôve been transported into the CGT Leaderboard code.</b><br>
      Think like a <b>Core Developer</b> to add or reject leaderboard entries and keep GQT leaderboards clean for players.
    </p>
    <div class="h3">Choose difficulty</div>
    <div class="row" style="gap:.6rem;flex-wrap:wrap;margin:.4rem 0 .8rem">
      <button class="btn primary" data-diff="practice">üü¢ Practice</button>
      <button class="btn primary" data-diff="standard">üü° Standard</button>
      <button class="btn primary" data-diff="pro">üî¥ Pro</button>
    </div>
    <div class="sub small">
      Difficulty changes card speed and how subtle mistakes are. You‚Äôll play <b>3 blocks</b>. Overall rank = total score across blocks.
    </div>
  </div>
</div>

<div class="overlay" id="paramsOv">
  <div class="dialog">
    <h3>Block parameters</h3>
    <div class="kv" style="margin:.4rem 0 .6rem">
      <div class="k">Block</div><div><b id="pBlockIdx">1/3</b></div>
      <div class="k">GQT ID</div><div id="pGqt">‚Äî</div>
      <div class="k">Score range</div><div id="pRange">‚Äî</div>
      <div class="k">Window</div><div id="pWindow">‚Äî</div>
    </div>
    <div class="sub" style="margin:.35rem 0 .6rem; line-height:1.5">
      <b>Instructions</b><br>
      üëÄ Check GQT ID<br>
      üëÄ Check Score Range<br>
      üëÄ Check Block Time<br><br>
      üåü Bonus: reject submissions that fail checks ‚ùå
    </div>
    <div class="row">
      <button class="btn primary" id="startBlock">Start block</button>
      <button class="btn" id="cancelParams">Cancel</button>
    </div>
  </div>
</div>

<div class="overlay" id="blockOv">
  <div class="dialog">
    <h3 id="blockTitle">Block complete</h3>
    <div id="blockSummary" class="sub" style="margin:.3rem 0 .6rem">‚Äî</div>
    <div class="row">
      <button class="btn primary" id="nextBlock">Next block</button>
      <button class="btn" id="quit">Quit</button>
    </div>
  </div>
</div>

<div class="overlay" id="endOv">
  <div class="dialog">
    <h3 id="endTitle">Run complete</h3>
    <div id="endBody" class="sub" style="margin:.3rem 0 .8rem">‚Äî</div>
    <div class="row">
      <button class="btn primary" id="endAgain">Start Again</button>
      <button class="btn" id="endClose">Close</button>
    </div>
  </div>
</div>

<!-- Flash feedback -->
<div class="flash" id="flash"></div>

<!-- Music -->
<audio id="bgm" preload="auto" loop
  src="https://raw.githubusercontent.com/cryptogamingtoken/cgt-games/main/sandbox/assets/Xdeviruchi%20-%208-Bit%20Fantasy%20Adventure%20Music%20(64%20KBps).mp3"></audio>

<script>
/* ======= Core config ======= */
const LB_SIZE = 5;
const CARDS_PER_BLOCK = 20;
const BLOCKS = 3;
const FOUR_HOURS = 1000*60*60*4;

/* ======= Scoring ======= */
const SC = {
  place_pos: +2,
  place_neg: -2,
  reject_pos: +3,
  reject_neg: -5,
  missing_slot: -2
};

/* ======= Difficulty ======= */
const DIFF = {
  practice:{ cardMs: 2500*3, label:'Practice' },
  standard:{ cardMs: 2500*2, label:'Standard' },
  pro:{ cardMs: 2500*1, label:'Pro' }
};

/* ======= State ======= */
let difficulty = 'standard';
let cardMs = DIFF[difficulty].cardMs;
let run=[], score=0, streak=0, blockIndex=0, lbRows=[], shown=0, timer=null;
let params=null, currentCard=null, seenTx=new Set();
let musicOn=true, sfxOn=true;
let decisions = []; // {block, ground, action, correct, points}

/* ======= DOM ======= */
const app = document.getElementById('app');
const introOv = document.getElementById('introOv');
const paramsOv = document.getElementById('paramsOv');
const blockOv = document.getElementById('blockOv');
const endOv   = document.getElementById('endOv');

const lbBody = document.querySelector('#lb tbody');
const txIdEl=tx('txId'), walletEl=tx('wallet'), scoreInEl=tx('scoreIn'), gqtInEl=tx('gqtIn'), timeInEl=tx('timeIn');
const cardNum=tx('cardNum'), scoreEl=tx('score'), streakEl=tx('streak'), blockNum=tx('blockNum'), winTxt=tx('winTxt');
const musicBtn=tx('musicBtn'), sfxBtn=tx('sfxBtn'), flashEl=tx('flash');
const endTitle = tx('endTitle'), endBody = tx('endBody');
function tx(id){return document.getElementById(id);}

/* ======= Audio ======= */
let ctx;
function ensureAudio(){
  try{
    if(!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)();
    if(ctx.state === 'suspended') ctx.resume();
    bgm.volume = 0.35; if(musicOn) bgm.play().catch(()=>{});
  }catch(e){}
}
document.addEventListener('pointerdown', ensureAudio, { once:true, passive:true });

function tone(freq=520,ms=80,gain=0.07,type='sine'){
  if(!sfxOn) return;
  try{
    ensureAudio(); if(!ctx||ctx.state!=='running') return;
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type=type; o.frequency.value=freq; g.gain.value=gain;
    o.connect(g); g.connect(ctx.destination); o.start();
    setTimeout(()=>o.stop(),ms);
  }catch(e){}
}
function cheerSfx(){ tone(760,100,.08); setTimeout(()=>tone(960,120,.07),110); }
function screamSfx(){ tone(220,200,.12,'square'); }

/* ======= Flash ======= */
function flashEmoji(emoji, color){
  flashEl.textContent = emoji;
  flashEl.style.color = color || '#fff';
  flashEl.classList.remove('show'); void flashEl.offsetWidth;
  flashEl.classList.add('show');
  setTimeout(()=>flashEl.classList.remove('show'), 600);
}

/* ======= Helpers ======= */
function randInt(min,max){ return Math.floor(Math.random()*(max-min+1))+min; }
function newGQT(){ return `GQT-${randInt(100,99999)}`; }
function now(){ return Date.now(); }
function fmtTime(t){ const d=new Date(t); return d.toTimeString().slice(0,8); }
function prettyWallet(raw){ return `${raw.slice(0,7)}‚Ä¶${raw.slice(-3)}`; }
function randomWalletRaw(){
  const alphabet='123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz';
  const len = randInt(30,44);
  let s=''; for(let i=0;i<len;i++) s += alphabet[randInt(0,alphabet.length-1)];
  return s;
}
function setHTML(id, html){ document.getElementById(id).innerHTML = html; }
function boldNumsInGQT(g){ const [p,n]=g.split('-'); return `${p}-<b>${n}</b>`; }
function boldRange(a,b){ return `<b>${a}</b> ‚Äì <b>${b}</b>`; }
function boldWindow(a,b){ return `<b>${fmtTime(a)}</b> ‚Üí <b>${fmtTime(b)}</b>`; }

/* ======= Params & Deck ======= */
function makeParams(){
  const start = now();
  const end = start + FOUR_HOURS;
  const gqt = newGQT();
  const minScore = randInt(0, 9000);
  const maxScore = minScore + randInt(1000, 90000);
  return { block: `${blockIndex+1}/${BLOCKS}`, gqt, start, end, minScore, maxScore };
}

function buildDeck(p, diff){
  const deck=[];
  const baseTx = ()=>'tx-'+Math.random().toString(36).slice(2,7);

  const correct = ()=>({
    kind:'ok',
    tx: baseTx(), wallet: randomWalletRaw(),
    score: randInt(p.minScore, p.maxScore),
    gqt: p.gqt,
    ts: randInt(p.start+10000, p.end-10000)
  });

  const wrong = {
    spoofScore_practice: ()=>({
      kind:'spoofScore', tx:baseTx(), wallet:randomWalletRaw(),
      score: randInt(p.maxScore+5000,p.maxScore+50000), gqt:p.gqt,
      ts:randInt(p.start+10000,p.end-10000)
    }),
    spoofScore_standard: ()=>({
      kind:'spoofScore', tx:baseTx(), wallet:randomWalletRaw(),
      score: randInt(p.maxScore+1000,p.maxScore+20000), gqt:p.gqt,
      ts:randInt(p.start+10000,p.end-10000)
    }),
    wrongBlock_pro: ()=>({
      kind:'wrongBlock', tx:baseTx(), wallet:randomWalletRaw(),
      score: randInt(p.minScore,p.maxScore), gqt:p.gqt,
      ts: randInt(p.start+10000,p.end-10000) + (Math.random()<.5?-1:1)*randInt(2,8)*60*1000
    }),
    wrongGQT_pro: ()=>{
      const num = p.gqt.split('-')[1];
      const pos = randInt(0,num.length-1);
      const rep = ((+num[pos]+1)%10).toString();
      return {kind:'wrongGQT', tx:baseTx(), wallet:randomWalletRaw(),
              score: randInt(p.minScore,p.maxScore), gqt:'GQT-'+(num.slice(0,pos)+rep+num.slice(pos+1)),
              ts:randInt(p.start+10000,p.end-10000)};
    },
    wrongBlock_standard: ()=>({
      kind:'wrongBlock', tx:baseTx(), wallet:randomWalletRaw(),
      score: randInt(p.minScore,p.maxScore), gqt:p.gqt,
      ts: randInt(p.start+10000,p.end-10000) + (Math.random()<.5?-1:1)*60*60*1000
    })
  };

  if(diff==='pro'){
    // Build exact batches of 6: 2 ok, 2 pro errors, 1 standard error, 1 practice-style error
    while(deck.length < CARDS_PER_BLOCK){
      const batch = [
        correct(), correct(),
        wrong.wrongGQT_pro(),
        wrong.wrongBlock_pro(),
        wrong.spoofScore_standard(),
        wrong.spoofScore_practice()
      ];
      // shuffle batch
      for(let i=batch.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [batch[i],batch[j]]=[batch[j],batch[i]]; }
      deck.push(...batch);
    }
    deck.length = CARDS_PER_BLOCK; // exact size
  } else {
    // Practice / Standard: reuse earlier mixes, scaled to 20
    const unit = (diff==='practice')
      ? ['ok','ok','ok','ok','spoofP','wblockS']      // ~66% ok
      : ['ok','ok','ok','wgqtP','spoofS','wblockS'];  // 50% ok
    while(deck.length < CARDS_PER_BLOCK){
      for(const tag of unit){
        if(deck.length >= CARDS_PER_BLOCK) break;
        if(tag==='ok') deck.push(correct());
        else if(tag==='spoofP') deck.push(wrong.spoofScore_practice());
        else if(tag==='spoofS') deck.push(wrong.spoofScore_standard());
        else if(tag==='wblockS') deck.push(wrong.wrongBlock_standard());
        else if(tag==='wgqtP'){ // practice-style GQT length change
          const g='GQT-'+randInt(1000000,9999999);
          deck.push({kind:'wrongGQT', tx:baseTx(), wallet:randomWalletRaw(),
                     score: randInt(p.minScore,p.maxScore), gqt:g,
                     ts:randInt(p.start+10000,p.end-10000)});
        }
      }
    }
  }
  // final shuffle
  for(let i=deck.length-1;i>0;i--){ const j=Math.floor(Math.random()*(i+1)); [deck[i],deck[j]]=[deck[j],deck[i]]; }
  deck.length = CARDS_PER_BLOCK;
  return deck;
}

/* ======= Flagging & LB ======= */
function renderParams(){
  setHTML('pBlockIdx', `${blockIndex+1}/${BLOCKS}`);
  setHTML('pGqt', boldNumsInGQT(params.gqt));
  setHTML('pRange', boldRange(params.minScore, params.maxScore));
  setHTML('pWindow', `${boldWindow(params.start, params.end)} (${Math.round((params.end-params.start)/36e5)}h)`);
  document.getElementById('winTxt').textContent = `${fmtTime(params.start)} ‚Üí ${fmtTime(params.end)}`;
  document.getElementById('blockNum').textContent = String(blockIndex+1);
}

function renderCard(c){
  txIdEl.textContent = c.tx;
  walletEl.textContent = prettyWallet(c.wallet);
  scoreInEl.textContent = c.score;
  gqtInEl.textContent = c.gqt;
  timeInEl.textContent = fmtTime(c.ts);
}

function flagFor(c){
  if(isDuplicate(c)) return 'duplicate';
  if(c.gqt !== params.gqt) return 'wrongGQT';
  if(c.score < params.minScore || c.score > params.maxScore) return 'spoofScore';
  if(c.ts < params.start || c.ts > params.end) return 'wrongBlock';
  return 'ok';
}
function flagClass(flag){ return flag==='ok' ? 'good' : (flag==='wrongBlock' ? 'warn' : 'bad'); }
function isDuplicate(c){ return seenTx.has(c.tx); }
function groundTruth(card){ return (flagFor(card)==='ok' && !isDuplicate(card)) ? 'good' : 'bad'; }

function addLB(c, explicitFlag){
  seenTx.add(c.tx);
  const flag = explicitFlag || 'ok';
  lbRows.push({wallet:c.wallet, score:c.score, ts:c.ts, flag});
  lbRows.sort((a,b)=> b.score - a.score || a.ts - b.ts);
  if(lbRows.length>LB_SIZE) lbRows.length=LB_SIZE;

  lbBody.innerHTML='';
  lbRows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    const td=(t)=>{const d=document.createElement('td'); d.textContent=t; return d;};
    tr.appendChild(td(i+1));
    tr.appendChild(td(prettyWallet(r.wallet)));
    tr.appendChild(td(r.score));
    tr.appendChild(td(fmtTime(r.ts)));
    const f=document.createElement('td'); f.className='flag '+flagClass(r.flag);
    f.textContent = r.flag==='ok' ? '‚úì ok' :
                    r.flag==='wrongBlock' ? '‚è± wrong block' :
                    r.flag==='spoofScore' ? 'üß™ score out' :
                    r.flag==='wrongGQT' ? 'üÜî wrong GQT' :
                    '‚õî duplicate';
    tr.appendChild(f);
    lbBody.appendChild(tr);
  });

  run.push({block:blockIndex+1, action:'accept', tx:c.tx, wallet:c.wallet, score:c.score, gqt:c.gqt,
            submitted:c.ts, flag});
}

function updateHUD(){
  scoreEl.textContent = String(score);
  streakEl.textContent = String(streak);
}

/* ======= Flow ======= */
function show(el){ el.style.display='flex'; }
function hide(el){ el.style.display='none'; }
function clearTimer(){ if(timer){clearTimeout(timer); timer=null;} }

function resetState(){
  run=[]; score=0; streak=0; blockIndex=0; decisions=[]; seenTx.clear();
  lbRows=[]; lbBody.innerHTML=''; shown=0; clearTimer();
  cardNum.textContent = `0/${CARDS_PER_BLOCK}`;
  scoreEl.textContent = '0'; streakEl.textContent = '0';
  document.getElementById('blockNum').textContent = '1';
  document.getElementById('winTxt').textContent = '‚Äî';
  app.style.display='none';
}

function startRun(){
  resetState();
  app.style.display='grid';
  nextBlock();
}

function nextBlock(){
  if(blockIndex>=BLOCKS){ return endRun(); }
  lbRows=[]; lbBody.innerHTML='';
  shown=0; clearTimer();
  params = makeParams();
  renderParams();
  show(paramsOv);
}

function beginBlock(){
  hide(paramsOv);
  const deck = buildDeck(params, difficulty);
  setCardsCount(0);
  pushNextCard();

  function setCardsCount(n){ cardNum.textContent = `${n}/${CARDS_PER_BLOCK}`; }

  function pushNextCard(){
    if(shown>=CARDS_PER_BLOCK){ return pauseBlock('Block complete', /*deckEnded=*/true); }
    currentCard = deck[shown++];
    setCardsCount(shown);
    renderCard(currentCard);
    clearTimer();
    timer = setTimeout(()=>{
      // Timeout: ignore scoring and max; just advance
      pushNextCard();
    }, cardMs);
  }

  function pauseBlock(title, deckEnded){
    clearTimer();

    let missingPenalty = 0;
    if(deckEnded && lbRows.length < LB_SIZE){
      const missing = LB_SIZE - lbRows.length;
      missingPenalty = missing * SC.missing_slot;
      score += missingPenalty;
    }

    const ok=lbRows.filter(r=>r.flag==='ok').length;
    const bad=lbRows.length-ok;
    const extra = missingPenalty ? ` ‚Ä¢ Missing slots penalty: <b>${missingPenalty}</b>` : '';
    const summary=`Accepted: <b>${lbRows.length}</b> (‚úÖ ${ok} ‚Ä¢ ‚ö†Ô∏è/‚ùå ${bad})${extra} ‚Ä¢ Score so far: <b>${score}</b>`;
    setHTML('blockTitle', title);
    setHTML('blockSummary', summary);

    // Final block? Change CTA to ‚ÄúDeveloper grading‚Äù
    const nextBtn = document.getElementById('nextBlock');
    if(blockIndex === BLOCKS-1){
      nextBtn.textContent = 'Developer grading';
      nextBtn.onclick = ()=>{ hide(blockOv); endRun(); };
    }else{
      nextBtn.textContent = 'Next block';
      nextBtn.onclick = ()=>{ hide(blockOv); blockIndex++; nextBlock(); };
    }
    show(blockOv);
  }

  // accept
  document.getElementById('btnAccept').onclick = ()=>{
    if(!currentCard) return;
    clearTimer();
    const ground = groundTruth(currentCard);
    const isGood = (ground === 'good');

    if(isGood){
      addLB(currentCard,'ok');
      score += SC.place_pos; streak++; cheerSfx();
    }else{
      const fl = flagFor(currentCard);
      addLB(currentCard, fl);
      score += SC.place_neg; streak=0; tone(220,120,.12,'square');
    }
    decisions.push({block:blockIndex+1, ground, action:'accept', correct:isGood, points:isGood?SC.place_pos:SC.place_neg});
    updateHUD();

    currentCard=null;
    if(lbRows.length>=LB_SIZE || shown>=CARDS_PER_BLOCK){
      return pauseBlock('Block complete', /*deckEnded=*/shown>=CARDS_PER_BLOCK);
    }
    pushNextCard();
  };

  // reject
  document.getElementById('btnReject').onclick = ()=>{
    if(!currentCard) return;
    clearTimer();
    const ground = groundTruth(currentCard);
    const isBad = (ground === 'bad');

    if(isBad){
      score += SC.reject_pos; streak++; cheerSfx(); flashEmoji('üèÜ', '#5ee1a2');
    }else{
      score += SC.reject_neg; streak=0; screamSfx(); flashEmoji('üëª', '#ff6b6b');
    }
    decisions.push({block:blockIndex+1, ground, action:'reject', correct:isBad, points:isBad?SC.reject_pos:SC.reject_neg});
    updateHUD();

    currentCard=null;
    if(lbRows.length>=LB_SIZE || shown>=CARDS_PER_BLOCK){
      return pauseBlock('Block complete', /*deckEnded=*/shown>=CARDS_PER_BLOCK);
    }
    pushNextCard();
  };
}

/* ======= End ======= */
function computeMaxAvailable(){
  // Max is: if ground was good -> best action accept (+2)
  //         if ground was bad -> best action reject (+3)
  return decisions.reduce((sum,d)=> sum + (d.ground==='good' ? SC.place_pos : SC.reject_pos), 0);
}

function endRun(){
  hide(blockOv); hide(paramsOv); hide(introOv);
  clearTimer();

  const maxAvail = computeMaxAvailable();
  const pct = maxAvail>0 ? Math.round((score/maxAvail)*100) : 0;

  let stars=1, title='Sloppy Developer';
  if(pct>=80){ stars=3; title='Core Developer'; }
  else if(pct>=60){ stars=2; title='Average Developer'; }

  endTitle.textContent = `Run complete ‚Ä¢ ${'‚òÖ'.repeat(stars)}${'‚òÜ'.repeat(3-stars)} ‚Äî ${title}`;
  endBody.innerHTML =
    `Final Score: <b>${score}</b><br>`+
    `Max Available (decisions): <b>${maxAvail}</b><br>`+
    `Accuracy: <b>${pct}%</b>`;

  show(endOv);
}

/* ======= Controls ======= */
document.getElementById('startBlock').onclick = ()=>{ hide(blockOv); beginBlock(); };
document.getElementById('cancelParams').onclick = ()=>{ hide(paramsOv); show(introOv); };
document.getElementById('quit').onclick = ()=>{ hide(blockOv); show(introOv); };

document.getElementById('restart').onclick = ()=>{
  hide(blockOv); hide(paramsOv); hide(endOv); show(introOv);
  resetState();
};

document.getElementById('endAgain').onclick = ()=>{ hide(endOv); show(introOv); resetState(); };
document.getElementById('endClose').onclick = ()=>{ hide(endOv); show(introOv); resetState(); };

/* Difficulty pick ‚Äî IMPORTANT: startRun(), not nextBlock() */
introOv.querySelectorAll('[data-diff]').forEach(b=>{
  b.addEventListener('click',()=>{
    difficulty = b.dataset.diff;
    cardMs = DIFF[difficulty].cardMs;
    hide(introOv);
    app.style.display='grid';
    startRun();
  });
});

/* Toggles & Export */
musicBtn.onclick = ()=>{ musicOn=!musicOn; musicBtn.textContent=`Music: ${musicOn?'On':'Off'}`; if(musicOn){ bgm.play().catch(()=>{});} else bgm.pause(); };
sfxBtn.onclick   = ()=>{ sfxOn=!sfxOn; sfxBtn.textContent=`SFX: ${sfxOn?'On':'Off'}`; if(sfxOn) cheerSfx(); };

function exportRun(){
  const payload={
    game:"Dev L0 ‚Äì Leaderboard (Mock MVP) v0.10",
    difficulty, blocks:BLOCKS, lb_size:LB_SIZE, cards_per_block:CARDS_PER_BLOCK,
    params_last: params, score,
    decisions: decisions.length,
    max_available: computeMaxAvailable(),
    accuracy_percent: (function(){ const m=computeMaxAvailable(); return m>0?Math.round((score/m)*100):0; })(),
    run, ts:new Date().toISOString()
  };
  const text=JSON.stringify(payload,null,2);
  navigator.clipboard.writeText(text).then(()=>toast("Run exported ‚úÖ"))
    .catch(()=>{ console.log(text); toast("Copy failed‚Äîcheck console"); });
}
document.getElementById('exportBtn').onclick = ()=>exportRun();

function toast(msg){
  const t=document.createElement('div');
  t.textContent=msg; t.style.position='fixed'; t.style.left='50%'; t.style.bottom='18px';
  t.style.transform='translateX(-50%)'; t.style.background='#101722';
  t.style.border='1px solid #263448'; t.style.borderRadius='10px';
  t.style.padding='.55rem .75rem'; t.style.zIndex='99'; t.style.color='var(--ink)';
  t.style.boxShadow='0 10px 24px rgba(0,0,0,.35)'; document.body.appendChild(t);
  setTimeout(()=>t.remove(),1500);
}

/* Boot */
show(introOv);
</script>
</body>
</html>
