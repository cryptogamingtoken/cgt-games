<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CGTShop v0.83</title>
<style>
  :root{
    --bg:#0a0f14;
    --surface:#0f1620;
    --ink:#e6edf3;
    --ink-dim:#9fb0c2;
    --line:#223041;
    --good:#7cf08a;
    --bad:#ff8a8a;
    --hint:#c8d6e5;
    --bold-track:linear-gradient(to right, rgba(135,180,255,.8), rgba(135,180,255,0));
    --cons-track:linear-gradient(to right, rgba(124,240,138,.8), rgba(124,240,138,0));
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  }

  /* Header */
  header{
    position:sticky;
    top:0;
    z-index:10;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:12px 16px;
    background:rgba(15,22,32,.78);
    backdrop-filter:blur(8px);
    border-bottom:1px solid var(--line);
  }
  .hud{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{
    padding:6px 10px;
    border:1px solid var(--line);
    border-radius:999px;
    white-space:nowrap;
    font-size:13px;
  }
  .k{opacity:.7;margin-right:6px}
  .v{font-weight:700}
  .brand-badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    height:38px;
    padding:0 16px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#101a24;
    color:#a7c7ff;
    font-weight:900;
    letter-spacing:.6px;
    font-size:16px;
    box-shadow:0 0 0 2px rgba(42,123,212,.08) inset;
  }

  /* Stage */
  .stage{
    min-height:calc(100% - 70px);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
  }
  .card{
    width:min(960px,100%);
    min-height:72vh;
    background:linear-gradient(180deg,#0f1620 0%,#0c121a 100%);
    border:1px solid var(--line);
    border-radius:18px;
    padding:20px 14px;
    position:relative;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
  }

  /* Cinematic headline */
  .headline{
    font-size:clamp(20px,4.2vw,40px);
    font-weight:900;
    letter-spacing:.3px;
    text-align:center;
    margin:0 10px 8px;
    opacity:0;
    transform:translateX(40vw);
    animation:slideAcross 1.6s ease-out forwards;
  }
  @keyframes slideAcross{
    0%{opacity:0;transform:translateX(40vw)}
    15%{opacity:1}
    85%{opacity:1;transform:translateX(-40vw)}
    100%{opacity:1;transform:translateX(0)}
  }
  .type{
    color:var(--ink-dim);
    max-width:820px;
    text-align:center;
    min-height:64px;
    margin:6px 12px 12px;
    white-space:pre-line;
    font-size:14px;
    line-height:1.4;
  }

  /* Panel */
  .panel{
    width:100%;
    max-width:820px;
    margin-top:8px;
  }
  .panel-inner{
    background:#111a27;
    border:1px solid var(--line);
    border-radius:14px;
    padding:14px;
  }
  .row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .btn{
    cursor:pointer;
    border:1px solid var(--line);
    background:#122034;
    color:#e6edf3;
    padding:9px 12px;
    border-radius:10px;
    transition:background .16s, box-shadow .16s, transform .08s;
    font-size:14px;
  }
  .btn:hover{background:#162a43}
  .btn:active{transform:scale(.97)}
  .muted{opacity:.8;font-size:12px}
  .choice-row{
    margin-bottom:10px;
  }
  .btn.choice{
    flex:1 1 140px;
    text-align:center;
    font-weight:700;
  }
  .btn.choice.cons{
    border-color:rgba(124,240,138,.6);
  }
  .btn.choice.bold{
    border-color:rgba(135,180,255,.6);
  }
  .btn.choice.selected{
    box-shadow:0 0 0 2px rgba(255,255,255,.15) inset;
  }

  /* Slider */
  #sliderBlock{
    margin-top:6px;
    display:none;
  }
  .slider-label-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    margin-bottom:4px;
  }
  .label{
    opacity:.8;
    font-size:12px;
  }
  .slider-value{
    font-weight:700;
    font-size:13px;
  }
  .sliderWrap{
    width:100%;
  }
  input[type="range"]{
    width:100%;
    -webkit-appearance:none;
    height:6px;
    border-radius:999px;
    background:#182333;
    outline:none;
    margin:8px 0;
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;
    appearance:none;
    width:18px;
    height:18px;
    border-radius:50%;
    background:#ffffff;
    border:2px solid #2a7bd4;
    box-shadow:0 0 12px rgba(42,123,212,.6);
    cursor:pointer;
    margin-top:-6px;
  }
  input[type="range"]::-moz-range-thumb{
    width:18px;
    height:18px;
    border-radius:50%;
    background:#ffffff;
    border:2px solid #2a7bd4;
    box-shadow:0 0 12px rgba(42,123,212,.6);
    cursor:pointer;
  }
  input[type="range"]::-webkit-slider-runnable-track{
    height:6px;
    border-radius:999px;
    background:#182333;
  }
  input[type="range"]::-moz-range-track{
    height:6px;
    border-radius:999px;
    background:#182333;
  }

  .card.bold-mode input[type="range"]::-webkit-slider-runnable-track{
    background:var(--bold-track);
  }
  .card.bold-mode input[type="range"]::-moz-range-track{
    background:var(--bold-track);
  }
  .card.cons-mode input[type="range"]::-webkit-slider-runnable-track{
    background:var(--cons-track);
  }
  .card.cons-mode input[type="range"]::-moz-range-track{
    background:var(--cons-track);
  }

  /* Outcome */
  .outcomeWrap{
    display:none;
    width:100%;
    max-width:820px;
    margin-top:10px;
  }
  .bigMsg{
    margin:6px 0 14px;
    padding:14px;
    text-align:center;
    line-height:1.08;
    font-size:clamp(20px,4.4vw,40px);
    font-weight:900;
    letter-spacing:.2px;
    white-space:pre-line;
  }
  .bigMsg.good{color:var(--good)}
  .bigMsg.bad{color:var(--bad)}
  .outcome{
    padding:16px;
    border-radius:12px;
    border:1px solid var(--line);
    text-align:center;
    font-size:14px;
  }
  .goodBox{
    background:#0f1c14;
    border-color:#234333;
    color:var(--good);
  }
  .badBox{
    background:#1c0f10;
    border-color:#432326;
    color:var(--bad);
  }
  .big{
    font-size:clamp(18px,2.6vw,26px);
    font-weight:900;
    margin-bottom:6px;
  }
  .center{
    display:flex;
    justify-content:center;
    gap:10px;
    margin-top:12px;
    flex-wrap:wrap;
  }

  /* Clue overlay */
  .flash{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#d9e6ff;
    font-weight:900;
    text-align:center;
    padding:16px;
    opacity:0;
    pointer-events:none;
    filter:blur(0);
  }
  .flash.show{
    animation:clueIn .4s ease-out forwards,
             clueHold 3.6s linear .4s forwards,
             clueOut .5s ease-in 4s forwards;
  }
  @keyframes clueIn{
    0%{opacity:0;transform:scale(.85);filter:blur(2px)}
    100%{opacity:1;transform:scale(1);filter:blur(0)}
  }
  @keyframes clueHold{
    0%{opacity:1}
    100%{opacity:1}
  }
  @keyframes clueOut{
    0%{opacity:1}
    100%{opacity:0;transform:scale(1.03)}
  }
  .flashInner{
    background:rgba(7,11,16,.90);
    border:1px solid #2a7bd4;
    border-radius:16px;
    padding:18px 22px;
    font-size:clamp(18px,3.8vw,32px);
    box-shadow:0 0 0 2px rgba(42,123,212,.15) inset;
  }

  /* Bias HUD */
  .bias-hud{
    position:fixed;
    inset:auto 12px 12px auto;
    max-width:240px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(95,134,210,.8);
    background:rgba(7,12,20,.96);
    color:#dbe5ff;
    font-size:12px;
    box-shadow:0 10px 28px rgba(0,0,0,.5);
    backdrop-filter:blur(8px);
    z-index:20;
    display:none;
  }
  .bias-hud-header{
    font-weight:700;
    margin-bottom:4px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:6px;
  }
  .bias-hud-header span{font-size:13px;}
  .bias-value{
    font-weight:700;
    font-size:13px;
  }
  #biasSlider{
    width:100%;
    margin-top:6px;
  }
  .meta{
    margin-top:2px;
  }

  @media (min-width:768px){
    .panel-inner{
      padding:16px 18px;
    }
    .btn{
      font-size:14px;
    }
  }
  /* ==========================================
   Enhanced Path UI (Cinematic)
========================================== */

.path-title {
  font-size: clamp(22px, 4vw, 38px);
  font-weight: 900;
  text-align: center;
  margin: 4px 0 6px;
  position: relative;
  letter-spacing: .3px;
  opacity: 0;
  transform: translateY(-10px);
  animation: fadeInUp .45s ease-out forwards;
}

.path-desc {
  text-align: center;
  font-size: 14px;
  margin: 0 auto 12px;
  line-height: 1.45;
  opacity: 0;
  transform: translateY(4px);
  animation: fadeInUp .45s ease-out .1s forwards;
  max-width: 700px;
  white-space: normal;
}

/* Blue flame for Bold */
.path-title.bold::before {
  content: "üî•";
  font-size: 26px;
  position: absolute;
  left: -38px;
  top: 2px;
  opacity: .9;
}

/* Green shield for Conservative */
.path-title.cons::before {
  content: "üõ°Ô∏è";
  font-size: 23px;
  position: absolute;
  left: -38px;
  top: 3px;
  opacity: .9;
}

/* Cinematic gradient underline */
.path-title::after {
  content:"";
  position:absolute;
  left:50%;
  bottom:-6px;
  transform:translateX(-50%);
  width: 60%;
  height: 3px;
  border-radius: 999px;
}

.path-title.bold::after {
  background: linear-gradient(90deg,
    rgba(135,180,255,0) 0%,
    rgba(135,180,255,1) 50%,
    rgba(135,180,255,0) 100%
  );
}

.path-title.cons::after {
  background: linear-gradient(90deg,
    rgba(124,240,138,0) 0%,
    rgba(124,240,138,1) 50%,
    rgba(124,240,138,0) 100%
  );
}

@keyframes fadeInUp {
  0% { opacity:0; transform:translateY(10px); }
  100% { opacity:1; transform:translateY(0); }
}
/* ======================================
   Outcome ‚Äî Cinematic Header
====================================== */

.outcome-title {
  font-size: clamp(20px, 3.8vw, 34px);
  font-weight: 900;
  text-align: center;
  margin-bottom: 6px;
  animation: fadeInUp .45s ease-out forwards;
}

.outcome-title.bold {
  color: rgba(135,180,255,1);
}
.outcome-title.cons {
  color: rgba(124,240,138,1);
}

.outcome-sub {
  font-size: clamp(16px, 3vw, 26px);
  font-weight: 700;
  text-align: center;
  opacity: 0;
  animation: fadeInUp .45s ease-out .08s forwards;
}

.outcome-sub.good {
  color: var(--good);
}
.outcome-sub.bad {
  color: var(--bad);
}

.outcome-desc {
  margin-top: 12px;
  max-width: 740px;
  margin-left: auto;
  margin-right: auto;
  font-size: 14px;
  text-align: center;
  color: var(--ink-dim);
  line-height: 1.45;
  opacity: 0;
  animation: fadeInUp .45s ease-out .18s forwards;
}
  /* ======================================================
   Dynamic Slider Theme (Bold ‚Üî Conservative)
   ====================================================== */

/* Main slider transition container */
.sliderWrap input[type="range"] {
  transition: all 0.45s ease-in-out;
}

/* ===========================
   TRACK gradients
   =========================== */

/* Conservative = fade to the LEFT (green) */
.card.cons-mode input[type="range"]::-webkit-slider-runnable-track {
  background: linear-gradient(to left,
    rgba(124,240,138,0.9),
    rgba(124,240,138,0)
  );
}
.card.cons-mode input[type="range"]::-moz-range-track {
  background: linear-gradient(to right,
    rgba(124,240,138,0.9),
    rgba(124,240,138,0)
  );
}

/* Bold = fade to the LEFT (blue) */
.card.bold-mode input[type="range"]::-webkit-slider-runnable-track {
  background: linear-gradient(to left,
    rgba(135,180,255,0.9),
    rgba(135,180,255,0)
  );
}
.card.bold-mode input[type="range"]::-moz-range-track {
  background: linear-gradient(to left,
    rgba(135,180,255,0.9),
    rgba(135,180,255,0)
  );
}

/* ===========================
   THUMB colors
   =========================== */

/* Conservative thumb = green */
.card.cons-mode input[type="range"]::-webkit-slider-thumb {
  background: rgba(124,240,138,1);
}
.card.cons-mode input[type="range"]::-moz-range-thumb {
  background: rgba(124,240,138,1);
}

/* Bold thumb = blue */
.card.bold-mode input[type="range"]::-webkit-slider-thumb {
  background: rgba(135,180,255,1);
}
.card.bold-mode input[type="range"]::-moz-range-thumb {
  background: rgba(135,180,255,1);
}

/* ===========================
   CARD glow animation
   =========================== */
.card {
  transition: box-shadow 0.45s ease-in-out;
}

.card.bold-mode {
  box-shadow: 0 0 24px rgba(135,180,255,0.28);
}

.card.cons-mode {
  box-shadow: 0 0 24px rgba(124,240,138,0.28);
}
/* Completely remove title/desc space during outcome */
.vanish {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
  height: 0 !important;
  min-height: 0 !important;
}
.card.outcome-mode {
  justify-content: flex-start !important;
  padding-top: 40px !important;
  padding-bottom: 40px !important;
  min-height: auto !important;
}
/* ================================
   Fix spacing when showing outcome
   ================================ */

.stage:has(.outcome-mode) {
  align-items: flex-start !important;
  padding-top: 40px !important;
}
</style>
</head>
<body>
  <!-- Founder scenarios data -->
  <script src="founder-data.js"></script>
  
  <header>
    <div class="hud">
      <div class="pill"><span class="k">Day</span><span class="v" id="day">1</span></div>
      <div class="pill"><span class="k">Price</span><span class="v" id="price">$0.00002857</span></div>
      <div class="pill"><span class="k">Market Cap</span><span class="v" id="mc">$10,000</span></div>
    </div>
    <span class="brand-badge">CGT</span>
  </header>

  <main class="stage">
    <section class="card" id="card">
      <div id="flash" class="flash"><div id="flashInner" class="flashInner">Signal‚Ä¶</div></div>

      <h1 id="title" class="headline">Loading‚Ä¶</h1>
      <p id="desc" class="type"></p>

      <div id="controls" class="panel" style="opacity:0;">
        <div class="panel-inner">
          <div class="row choice-row" id="choiceRow">
            <button id="consBtn" class="btn choice cons">Conservative path</button>
            <button id="boldBtn" class="btn choice bold">Bold path</button>
          </div>

          <div id="sliderBlock"></div>

          <div class="row" id="commitRow" style="margin-top:10px; display:none;">
            <button id="commit" class="btn">Commit decision</button>
            <button id="changeMind" class="btn">Change Mind üß†</button>
          </div>
          <div class="muted" id="hintRow" style="margin-top:4px;display:none;">
            Adjust your multiplier, then commit. Change your mind if you want to pick the other path.
          </div>
        </div>
      </div>

      <div id="outcomeWrap" class="outcomeWrap">
        <div id="bigMsg" class="bigMsg"></div>
        <div id="outcomeBox" class="outcome"></div>
        <div class="center">
          <button id="next" class="btn">Next day</button>
          <button id="restart" class="btn" style="display:none;">Restart</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Bias HUD -->
  <div id="biasHUD" class="bias-hud">
    <div class="bias-hud-header">
      <span>üé≤ Favourable bias</span>
      <span id="biasValue" class="bias-value">80%</span>
    </div>
    <input type="range" id="biasSlider" min="10" max="90" step="5" value="80">
    <div class="muted" style="margin-top:4px;">Two-finger tap (or press ‚ÄúB‚Äù) to toggle this during testing.</div>
    <div class="meta"><b>Ref:</b> <span id="metaRef">‚Äî</span></div>
    <div class="meta"><b>Tone:</b> <span id="metaTone">‚Äî</span></div>
    <div class="meta"><b>MC:</b> <span id="metaMC">‚Äî</span></div>
  </div>

  
<script>
/* ========= Core state ========= */
const SUPPLY = 350_000_000;
let day = 1;
let price = 10_000 / SUPPLY;
let bias = 80;          // default 80% favourable
let locked = false;
let chosenPath = null;  // 'bold' or 'conservative'
let sliderInput = null;
let hasOutcomeShown = false;
let currentScenario = null;

function mc(){ return price * SUPPLY; }
function fmtUSD(n, d=8){
  const o = {
    minimumFractionDigits:(n<1?d:2),
    maximumFractionDigits:(n<1?d:2)
  };
  return '$'+n.toLocaleString(undefined,o);
}

/* ========= Utilities ========= */
const $ = s => document.querySelector(s);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function rand(min,max){ return Math.random()*(max-min)+min; }

/* ========= DOM ========= */
const elDay = $('#day');
const elPrice = $('#price');
const elMC = $('#mc');
const elTitle = $('#title');
const elDesc = $('#desc');
const elControls = $('#controls');
const elOutcomeWrap = $('#outcomeWrap');
const elBigMsg = $('#bigMsg');
const elOutcomeBox = $('#outcomeBox');
const elNext = $('#next');
const elRestart = $('#restart');
const elFlash = $('#flash');
const elFlashInner = $('#flashInner');
const elCard = $('#card');

const elConsBtn = $('#consBtn');
const elBoldBtn = $('#boldBtn');
const elChoiceRow = $('#choiceRow');
const elSliderBlock = $('#sliderBlock');
const elCommitRow = $('#commitRow');
const elHintRow = $('#hintRow');
const elCommit = $('#commit');
const elChangeMind = $('#changeMind');

const elBiasHUD = $('#biasHUD');
const elBiasSlider = $('#biasSlider');
const elBiasValue = $('#biasValue');
const elMetaRef = $('#metaRef');
const elMetaTone = $('#metaTone');
const elMetaMC = $('#metaMC');

/* ========= Data ========= */
let founderScenarios = (window.CGT_SCENARIOS && window.CGT_SCENARIOS.founder) || [];
if (!Array.isArray(founderScenarios) || founderScenarios.length === 0){
  founderScenarios = [{
    subBand:'F-B1-0.1',
    marketCap:'$10 K',
    focus:'First spark',
    context:'Barely off the ground; prototype exists, but nobody‚Äôs watching.',
    tone:'risky',
    outcomeA:'Early adopters rally behind the MVP, posting screenshots and feedback that spark a viral micro-wave of credibility.',
    outcomeB:'Launch exposes half-finished systems; bugs and confusion dominate the narrative, causing early trust erosion.',
    outcomeC:'A few testers privately confirm the build‚Äôs strength; quiet progress builds word-of-mouth trust.',
    outcomeD:'Delays frustrate insiders who drift away, leaving the project isolated before momentum forms.'
  }];
}

/* ==== Ref MC helpers ==== */
function parseRefMC(str){
  if(!str) return 0;
  const m = String(str).replace('+','').trim().match(/([\d.]+)\s*([KMB])/i);
  if(!m) return 0;
  const v = parseFloat(m[1]);
  const u = m[2].toUpperCase();
  const mul = u==='K'?1e3:u==='M'?1e6:1e9;
  return v*mul;
}
function pickScenarioForMC(curMC, list){
  let best = null, bestDiff = Infinity;
  for(const s of list){
    const ref = parseRefMC(s.marketCap);
    if(!ref) continue;
    const diff = Math.abs(ref - curMC);
    if(diff < bestDiff){
      bestDiff = diff;
      best = s;
    }
  }
  return best || list[0];
}

/* ========= HUD ========= */
function updateHUD(){
  elDay.textContent = String(day);
  elPrice.textContent = fmtUSD(price,8);
  elMC.textContent = fmtUSD(mc());
}

/* ========= Typewriter ========= */
async function typewrite(el, text, speed=28){
  el.textContent = '';
  for(let i=0;i<text.length;i++){
    el.textContent += text[i];
    await sleep(speed);
  }
}

/* ========= Clue overlay ========= */
async function maybeShowClueBlocking(){
  const p = rand(1/7, 1/4);
  if (Math.random() < p){
    const msgs = [
      "Community buzz rising",
      "Regulatory fog ahead",
      "Infra feels solid",
      "Liquidity thin",
      "Streamer whispers‚Ä¶"
    ];
    elFlashInner.textContent = msgs[Math.floor(Math.random()*msgs.length)] || "Signal incoming‚Ä¶";
    elFlash.classList.add('show');
    await sleep(4600);
    elFlash.classList.remove('show');
    await sleep(700);
  }
}

/* ========= Bands ‚Üí slider ranges ========= */
function getBandRange(subBand){
  const parts = (subBand || '').split('-'); // e.g. F-B2-0.3
  const bandCode = parts[1] || '';
  let max = 3.0;
  if (bandCode === 'B1') max = 5.0;
  else if (bandCode === 'B2') max = 4.0;
  else if (bandCode === 'B3') max = 3.0;
  else if (bandCode === 'B4') max = 2.0;
  else if (bandCode === 'B5') max = 1.0;
  return {min:0.1, max, step:0.1};
}

/* ========= Slider rendering ========= */
function renderSlider(range, path){
  elSliderBlock.innerHTML = '';

  const labelRow = document.createElement('div');
  labelRow.className = 'slider-label-row';

  const lbl = document.createElement('div');
  lbl.className = 'label';
  lbl.textContent = 'Risk multiplier';

  const val = document.createElement('div');
  val.className = 'slider-value';
  val.id = 'sliderValue';

  labelRow.appendChild(lbl);
  labelRow.appendChild(val);

  const wrap = document.createElement('div');
  wrap.className = 'sliderWrap';

  const input = document.createElement('input');
  input.type = 'range';
  input.min = range.min;
  input.max = range.max;
  input.step = range.step;
  input.value = range.min;

  const updateLabel = () => {
    const v = parseFloat(input.value || range.min);
    val.textContent = v.toFixed(1) + '√ó';
  };
  input.addEventListener('input', updateLabel);
  updateLabel();
  wrap.appendChild(input);

  // Conservative path: visually reverse slider
  if (path === 'conservative'){
    wrap.style.transform = 'scaleX(-1)';
  } else {
    wrap.style.transform = 'none';
  }

  elSliderBlock.appendChild(labelRow);
  elSliderBlock.appendChild(wrap);

  elSliderBlock.style.display = 'block';
  elCommitRow.style.display = 'flex';
  elHintRow.style.display = 'block';

  // Button order: conservative = Commit | Change, bold = Change | Commit
  elCommitRow.style.flexDirection = (path === 'bold') ? 'row-reverse' : 'row';

  sliderInput = input;
}

/* ========= Decision UI ========= */
function resetDecisionUI(){
  chosenPath = null;

  elConsBtn.classList.remove('selected');
  elBoldBtn.classList.remove('selected');
  elChoiceRow.style.display = 'flex';
  elSliderBlock.style.display = 'none';
  elCommitRow.style.display = 'none';
  elHintRow.style.display = 'none';
  sliderInput = null;
  elCard.classList.remove('bold-mode','cons-mode');

  // Restore original scenario UI
  if (currentScenario) {
    elTitle.className = 'headline';
    elTitle.textContent = `Founders ¬∑ ${currentScenario.focus || ''}`;

    elDesc.className = 'type';
    elDesc.textContent = currentScenario.context || '';
  }
}

function choosePath(path, range){
  chosenPath = path;
  elChoiceRow.style.display = 'none';

  // Mode classes
  if (path === 'bold'){
    elBoldBtn.classList.add('selected');
    elConsBtn.classList.remove('selected');
    elCard.classList.add('bold-mode');
    elCard.classList.remove('cons-mode');
  } else {
    elConsBtn.classList.add('selected');
    elBoldBtn.classList.remove('selected');
    elCard.classList.add('cons-mode');
    elCard.classList.remove('bold-mode');
  }

  // Replace UI headline + description
  if (currentScenario) {
    elTitle.classList.remove('headline');
    elTitle.className = 'path-title ' + (path === 'bold' ? 'bold' : 'cons');

    elTitle.textContent = path === 'bold'
      ? "Bold Path"
      : "Conservative Path";

    elDesc.className = 'path-desc';
    elDesc.textContent = path === 'bold'
      ? currentScenario.boldPrompt || ""
      : currentScenario.conservativePrompt || "";
  }

  renderSlider(range, path);
}

/* ========= New scenario ========= */
async function newScenario(){
  locked = false;
  hasOutcomeShown = false;
  resetDecisionUI();

  elOutcomeWrap.style.display = 'none';
  elTitle.textContent = 'Loading‚Ä¶';
  elDesc.textContent = '';
  elControls.style.opacity = 0;

  await maybeShowClueBlocking();

  currentScenario = pickScenarioForMC(mc(), founderScenarios);
  const s = currentScenario;

  // reset title animation
  elTitle.style.animation = 'none';
  void elTitle.offsetWidth;
  elTitle.style.animation = null;

  const titleText = `Founders ¬∑ ${s.focus || 'Founder Scenario'}`;
  elTitle.textContent = titleText;

  await sleep(1600 + 250);

  // Only context on main card
  await typewrite(elDesc, s.context || '', 26);

  // bias HUD meta
  if (elMetaRef)  elMetaRef.textContent  = s.subBand || '‚Äî';
  if (elMetaTone) elMetaTone.textContent = s.tone || '‚Äî';
  if (elMetaMC)   elMetaMC.textContent   = s.marketCap || '‚Äî';

  await sleep(250);
  elControls.style.opacity = 1;

  const bandRange = getBandRange(s.subBand);

  elConsBtn.onclick = () => choosePath('conservative', bandRange);
  elBoldBtn.onclick = () => choosePath('bold', bandRange);
}

/* ========= Outcome logic ========= */
function resolveDecision(){
  if (locked) return;
  if (!currentScenario) return;

  if (!chosenPath){
    alert('Choose Conservative or Bold first.');
    return;
  }
  if (!sliderInput){
    alert('Set your multiplier before committing.');
    return;
  }

  const range = getBandRange(currentScenario.subBand);
  let mult = parseFloat(sliderInput.value || range.min);
  mult = Math.max(range.min, Math.min(range.max, mult));

  const isFavourable = Math.random() < (bias / 100);
  const s = currentScenario;

  let outcomeText = '';
  if (chosenPath === 'bold'){
    outcomeText = isFavourable ? (s.outcomeA || '') : (s.outcomeB || '');
  } else {
    outcomeText = isFavourable ? (s.outcomeC || '') : (s.outcomeD || '');
  }

  applyOutcome(isFavourable, mult, outcomeText, s);
  locked = true;
}

function applyOutcome(isFavourable, mult, text, scenario){
  const oldMC = mc();
  let newMC;

  if (isFavourable){
    newMC = oldMC * mult;
  } else {
    const safeMult = Math.max(mult, 0.1);
    newMC = oldMC / safeMult;
  }

  price = newMC / SUPPLY;
  showOutcome(isFavourable, mult, text, scenario, oldMC, newMC);
}

function showOutcome(isFavourable, mult, text, scenario, oldMC, newMC){
  hasOutcomeShown = true;

  // Hide the main scenario header during outcome
elTitle.classList.add('vanish');
elDesc.classList.add('vanish');
elCard.classList.add('outcome-mode');
  elControls.style.opacity = 0;

  elBigMsg.className = 'bigMsg ' + (isFavourable ? 'good' : 'bad');
  const line1 = chosenPath === 'bold' ? 'Bold move' : 'Conservative move';
  const line2 = isFavourable ? 'Favourable outcome' : 'Unfavourable outcome';
  elBigMsg.innerHTML = `
  <div class="outcome-title ${chosenPath}">
    ${chosenPath === 'bold' ? 'üî• Bold Path' : 'üõ°Ô∏è Conservative Path'}
  </div>
  <div class="outcome-sub ${isFavourable ? 'good' : 'bad'}">
    ${isFavourable ? 'Favourable Outcome' : 'Unfavourable Outcome'}
  </div>
  <div class="outcome-desc">
    ${text}
  </div>
`;

  elOutcomeWrap.style.display = 'block';
  const cls = isFavourable ? 'goodBox' : 'badBox';
  elOutcomeBox.className = 'outcome ' + cls;

  // percentage purely from multiplier (5.0√ó -> ¬±500%)
  const pctAbs = mult * 100;
  const pctStr = (isFavourable ? '+' : '-') + pctAbs.toFixed(0) + '%';

  const priceLine = `Price: <b>${fmtUSD(oldMC/SUPPLY,8)}</b> ‚Üí <b>${fmtUSD(price,8)}</b>`;
  const mcLine = `Market Cap: <b>${fmtUSD(oldMC)}</b> ‚Üí <b>${fmtUSD(newMC)}</b>`;
  const focusLine = scenario ? `<div class="muted" style="margin-top:10px;">${scenario.focus || ''}</div>` : '';

  elOutcomeBox.innerHTML = `
    <div class="big">${isFavourable ? 'Gain' : 'Loss'} &nbsp; (${pctStr})</div>
    <div>${priceLine}</div>
    <div class="muted">${mcLine}</div>
    ${focusLine}
  `;

  if (price <= 0){
    elNext.style.display = 'none';
    elRestart.style.display = 'inline-block';
  } else {
    elNext.style.display = 'inline-block';
    elRestart.style.display = 'none';
  }

  updateHUD();
}

/* ========= Flow ========= */
function nextDay(){
  if (price <= 0) return;
  elTitle.classList.remove('vanish');
elDesc.classList.remove('vanish');
elCard.classList.remove('outcome-mode');

  day += 1;
  updateHUD();
  newScenario();
}

function restartGame(){
  elTitle.classList.remove('vanish');
elDesc.classList.remove('vanish');
elCard.classList.remove('outcome-mode');
  day = 1;
  price = 10_000 / SUPPLY;
  updateHUD();
  newScenario();
}

/* ========= Bias HUD ========= */
function updateBiasFromSlider(){
  bias = parseInt(elBiasSlider.value,10) || 80;
  elBiasValue.textContent = bias + '%';
}

function toggleBiasHUD(){
  if (elBiasHUD.style.display === 'block'){
    elBiasHUD.style.display = 'none';
  } else {
    elBiasHUD.style.display = 'block';
  }
}

/* ========= Init ========= */
(function init(){
  updateHUD();
  updateBiasFromSlider();

  elBiasSlider.addEventListener('input', updateBiasFromSlider);

  elCommit.addEventListener('click', resolveDecision);
  elChangeMind.addEventListener('click', ()=>{ if(!locked) resetDecisionUI(); });
  elNext.addEventListener('click', nextDay);
  elRestart.addEventListener('click', restartGame);

  // Tap-card to go next day once outcome is shown
  elCard.addEventListener('click', e => {
    if (!hasOutcomeShown) return;
    if (e.target.closest('.panel-inner') || e.target.closest('.btn') || e.target.closest('#biasHUD')) return;
    nextDay();
  });

  // Two-finger tap to toggle bias HUD (mobile)
  document.addEventListener('touchstart', e => {
    if (e.touches && e.touches.length >= 2){
      e.preventDefault();
      toggleBiasHUD();
    }
  }, {passive:false});

  // 'b' key toggles bias HUD (desktop testing)
  document.addEventListener('keydown', e => {
    if (e.key === 'b' || e.key === 'B'){
      toggleBiasHUD();
    }
  });

  newScenario();
})();
</script>
</body>
</html>
