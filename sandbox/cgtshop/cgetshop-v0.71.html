<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CGT Shop</title>
<style>
  :root{--bg:#0a0f14;--surface:#0f1620;--ink:#e6edf3;--ink-dim:#9fb0c2;--line:#223041;--good:#7cf08a;--bad:#ff8a8a;--hint:#c8d6e5}
  *{box-sizing:border-box} html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif}

  /* Header */
  header{position:sticky;top:0;z-index:10;display:flex;align-items:center;justify-content:space-between;gap:12px;padding:12px 16px;background:rgba(15,22,32,.78);backdrop-filter:blur(8px);border-bottom:1px solid var(--line)}
  .hud{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{padding:6px 10px;border:1px solid var(--line);border-radius:999px;white-space:nowrap}
  .k{opacity:.7;margin-right:6px}.v{font-weight:700}
  .brand-badge{display:inline-flex;align-items:center;justify-content:center;height:42px;padding:0 18px;border-radius:999px;border:1px solid var(--line);background:#101a24;color:#a7c7ff;font-weight:900;letter-spacing:.6px;font-size:18px;box-shadow:0 0 0 2px rgba(42,123,212,.08) inset}

  /* Stage */
  .stage{min-height:calc(100% - 70px);display:flex;align-items:center;justify-content:center;padding:18px}
  .card{width:min(980px,100%);min-height:72vh;background:linear-gradient(180deg,#0f1620 0%,#0c121a 100%);border:1px solid var(--line);border-radius:18px;padding:20px 18px;position:relative;overflow:hidden;display:flex;flex-direction:column;justify-content:center;align-items:center}

  /* Cinematic headline */
  .headline{font-size:clamp(22px,4.4vw,42px);font-weight:900;letter-spacing:.3px;text-align:center;margin:0 10px 8px;opacity:0;transform:translateX(40vw);animation:slideAcross 1.6s ease-out forwards}
  @keyframes slideAcross{0%{opacity:0;transform:translateX(40vw)}15%{opacity:1}85%{opacity:1;transform:translateX(-40vw)}100%{opacity:1;transform:translateX(0)}}
  .type{color:var(--ink-dim);max-width:820px;text-align:center;min-height:64px;margin:6px 12px 14px}

  .panel{width:100%;max-width:820px;margin-top:8px}
  .panel-inner{background:#111a27;border:1px solid var(--line);border-radius:14px;padding:16px}
  .row{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
  .label{opacity:.8} input[type="range"]{width:100%}
  .btn{cursor:pointer;border:1px solid var(--line);background:#122034;color:#e6edf3;padding:10px 14px;border-radius:10px}
  .btn:hover{background:#162a43} .muted{opacity:.8}

  /* Outcome focus */
  .outcomeWrap{display:none;width:100%;max-width:820px}
  .bigMsg{margin:6px 0 14px;padding:16px;text-align:center;line-height:1.08;font-size:clamp(22px,4.8vw,44px);font-weight:900;letter-spacing:.2px;white-space:pre-line}
  .bigMsg.good{color:var(--good)} .bigMsg.bad{color:var(--bad)}
  .outcome{padding:18px;border-radius:12px;border:1px solid var(--line);text-align:center}
  .goodBox{background:#0f1c14;border-color:#234333;color:var(--good)}
  .badBox{background:#1c0f10;border-color:#432326;color:var(--bad)}
  .big{font-size:clamp(18px,2.6vw,28px);font-weight:900}
  .center{display:flex;justify-content:center;gap:10px;margin-top:12px}

  /* Clue overlay (≥4s, blocks next day) */
  .flash{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;color:#d9e6ff;font-weight:900;text-align:center;padding:16px;opacity:0;pointer-events:none;filter:blur(0)}
  .flash.show{animation:clueIn .4s ease-out forwards, clueHold 3.6s linear .4s forwards, clueOut .5s ease-in 4s forwards}
  @keyframes clueIn{0%{opacity:0;transform:scale(.85);filter:blur(2px)}100%{opacity:1;transform:scale(1);filter:blur(0)}}
  @keyframes clueHold{0%{opacity:1}100%{opacity:1}}
  @keyframes clueOut{0%{opacity:1}100%{opacity:0;transform:scale(1.03)}}
  .flashInner{background:rgba(7,11,16,.90);border:1px solid #2a7bd4;border-radius:16px;padding:18px 22px;font-size:clamp(18px,3.8vw,32px);box-shadow:0 0 0 2px rgba(42,123,212,.15) inset}
</style>
</head>
<body>
  <header>
    <div class="hud">
      <div class="pill"><span class="k">Day</span><span class="v" id="day">1</span></div>
      <div class="pill"><span class="k">Price</span><span class="v" id="price">$0.00002857</span></div>
      <div class="pill"><span class="k">Market Cap</span><span class="v" id="mc">$10,000</span></div>
    </div>
    <span class="brand-badge">CGT</span>
  </header>

  <main class="stage">
    <section class="card">
      <div id="flash" class="flash"><div id="flashInner" class="flashInner">Signal…</div></div>

      <h1 id="title" class="headline">Loading…</h1>
      <p id="desc" class="type"></p>

      <div id="controls" class="panel" style="opacity:0;">
        <div class="panel-inner">
          <div id="intensityBlock"></div>
          <div class="row" style="margin-top:12px">
            <button id="commit" class="btn">Commit</button>
            <span class="muted">0% = no risk. Higher = bigger swings.</span>
          </div>
        </div>
      </div>

      <div id="outcomeWrap" class="outcomeWrap">
        <div id="bigMsg" class="bigMsg"></div>
        <div id="outcomeBox" class="outcome"></div>
        <div class="center">
          <button id="next" class="btn">Next day</button>
          <button id="restart" class="btn" style="display:none;">Restart</button>
        </div>
      </div>
    </section>
  </main>

<script>
/* ========= Core state ========= */
const SUPPLY = 350_000_000;
let day = 1;
let price = 10_000 / SUPPLY;       // seed from MC / supply
let START_MC = price * SUPPLY;     // capture starting MC for volatility bands
function mc(){ return price * SUPPLY; }
function fmtUSD(n, d=8){ const o={minimumFractionDigits:(n<1?d:2), maximumFractionDigits:(n<1?d:2)}; return '$'+n.toLocaleString(undefined,o); }

/* ========= Utilities & Patches ========= */
const $ = s=>document.querySelector(s);
const sleep = ms=>new Promise(r=>setTimeout(r,ms));
function choose(arr){ if(!arr || !arr.length) return null; return arr[Math.floor(Math.random()*arr.length)]; }
function pickWeighted(arr){
  if(!arr || !arr.length) return null;
  const t=arr.reduce((s,o)=>s+(o.weight||0),0)||0;
  if(t<=0) return arr[0];
  let r=Math.random()*t;
  for(const o of arr){ r-= (o.weight||0); if(r<=0) return o; }
  return arr[0];
}
function rand(min,max){ return Math.random()*(max-min)+min; }

/* ========= Volatility curve (go big when MC is low) ========= */
function volatilityBoost(curMC, startMC){
  const r = curMC / startMC;
  if (r >= 50) return {mult:1.0, ex:1.0, floor:0.40, minSnap:null};
  if (r >= 10) return {mult:1.2, ex:1.2, floor:0.40, minSnap:null};
  if (r >= 1)  return {mult:1.6, ex:1.6, floor:0.35, minSnap:null};
  return {mult:2.3, ex:2.5, floor:0.25, minSnap:0.35}; // Band D: bigger swings & lower survivability floor
}

/* ========= Scenes (full pack) =========
   Each: { id, title, intro, intensity, outcomes[{label,mult:[min,max],weight,catastrophic?}], volScale, posLines[2], negLines[2] }
*/
const SCENES = [
  // Creators / Distribution
  { id:"creators-flood", title:"3rd-Party Creators — Listing Flood",
    intro:"Creators tee up a wave of GQTs.",
    intensity:{type:"quantity", label:"How many GQTs today?", min:0, max:150000, step:3000, unit:"GQTs"},
    outcomes:[
      {label:"Ignored by feed", mult:[0.25,0.60], weight:20, catastrophic:true},
      {label:"Muted interest",  mult:[0.70,0.98], weight:35},
      {label:"Solid traction",  mult:[1.12,1.85], weight:35},
      {label:"Explosive hype (2–5×)", mult:[2.0,5.0], weight:10}
    ],
    volScale:0.70,
    posLines:["Feed catches","Demand rips!"],
    negLines:["Timing clashes","Listings sink"]
  },
  { id:"creators-collab", title:"Creators — Cross-Collab Drop",
    intro:"Two creator teams sync a surprise collab.",
    intensity:{type:"percent", label:"Push coordination level?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"Misaligned timing", mult:[0.50,0.85], weight:20},
      {label:"Decent synergy",   mult:[1.10,1.60], weight:55},
      {label:"Lightning in a bottle (2–3×)", mult:[2.0,3.0], weight:25}
    ],
    volScale:0.50,
    posLines:["Synergy hits","Audience doubles back"],
    negLines:["Out of sync","Buzz evaporates"]
  },

  // Players / Community
  { id:"players-weekend", title:"Players — Weekend Tournament Wave",
    intro:"Community organisers rally players.",
    intensity:{type:"quantity", label:"How many weekend events?", min:0, max:1200, step:30, unit:"events"},
    outcomes:[
      {label:"Overshadowed", mult:[0.40,0.85], weight:25},
      {label:"Steady flow",  mult:[1.08,1.45], weight:50},
      {label:"Breakout run (2–4×)", mult:[2.0,4.0], weight:25}
    ],
    volScale:0.55,
    posLines:["Streamers bite","Tournaments boom"],
    negLines:["Competing events","Eyes drift away"]
  },
  { id:"players-streamer", title:"Players — Mega-Streamer Enters",
    intro:"A top streamer teases a CGT run.",
    intensity:{type:"percent", label:"How much to prime the event?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"No-show drama", mult:[0.35,0.80], weight:15, catastrophic:true},
      {label:"Soft cameo",    mult:[1.05,1.30], weight:45},
      {label:"Feature stream (3–6×)", mult:[3.0,6.0], weight:30},
      {label:"48h clip craze (10×)",  mult:[8.0,10.0], weight:10}
    ],
    volScale:0.80,
    posLines:["Clip goes nuclear","Wallets swarm"],
    negLines:["Schedule slips","Hype turns sour"]
  },

  // Marketing & Ops
  { id:"mktg-thread", title:"Marketing — Influencer Thread",
    intro:"A mid-tier influencer offers a thread.",
    intensity:{type:"percent", label:"How hard to support?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"Backlash",   mult:[0.45,0.85], weight:18},
      {label:"Neutral",    mult:[0.98,1.05], weight:34},
      {label:"Nice pop",   mult:[1.15,1.80], weight:38},
      {label:"Viral chain (2–3×)", mult:[2.0,3.0], weight:10}
    ],
    volScale:0.45,
    posLines:["Thread lands","Curiosity spreads"],
    negLines:["Tone misread","Engagement dips"]
  },
  { id:"mktg-sponsor", title:"Marketing — Surprise Sponsor",
    intro:"A gaming sponsor wants a pilot.",
    intensity:{type:"percent", label:"Commit budget share?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"Pilot fizzles", mult:[0.60,0.95], weight:30},
      {label:"Solid fit",     mult:[1.10,1.70], weight:50},
      {label:"Brand halo (2–4×)", mult:[2.0,4.0], weight:20}
    ],
    volScale:0.60,
    posLines:["Perfect alignment","Brand halo forms"],
    negLines:["Audience mismatch","Spend looks wasted"]
  },

  // Core Devs
  { id:"dev-stability", title:"Core Devs — Stability Release",
    intro:"A minor stability upgrade lands.",
    intensity:{type:"percent", label:"Rollout scale?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"Bug backlash", mult:[0.55,0.90], weight:12},
      {label:"Neutral day",  mult:[0.96,1.04], weight:38},
      {label:"Reassuring",   mult:[1.06,1.30], weight:50}
    ],
    volScale:0.35,
    posLines:["Reliability whispers","Confidence builds"],
    negLines:["Hidden bug","Confidence shaken"]
  },
  { id:"dev-bridge", title:"Core Devs — Solana Bridge Upgrade",
    intro:"Bridge throughput gets a serious tune.",
    intensity:{type:"percent", label:"Risk budget for rollout?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"Bridge hiccup", mult:[0.40,0.85], weight:15},
      {label:"Smooth lift",   mult:[1.10,1.80], weight:55},
      {label:"Cross-chain mania (2–5×)", mult:[2.0,5.0], weight:30}
    ],
    volScale:0.70,
    posLines:["Throughput sings","New wallets pour"],
    negLines:["Throughput stutters","FUD around bridge"]
  },

  // Regulatory / Macro
  { id:"reg-fog", title:"Regulatory Fog — Rumour Mill",
    intro:"Sector-wide review whispers.",
    intensity:{type:"percent", label:"Comms posture?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"Flash panic",  mult:[0.20,0.60], weight:18, catastrophic:true},
      {label:"Caution day",  mult:[0.72,0.98], weight:50},
      {label:"False alarm",  mult:[1.00,1.18], weight:22},
      {label:"Counter-rally",mult:[1.30,2.20], weight:10}
    ],
    volScale:0.75,
    posLines:["Calm assurance","Room steadies"],
    negLines:["Rumours swirl","Risk-off grips"]
  },
  { id:"macro-hot", title:"Macro — Risk-On Window",
    intro:"Markets open strong with broad risk-on.",
    intensity:{type:"percent", label:"Lean into momentum?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"Short-lived bounce", mult:[0.80,1.05], weight:30},
      {label:"Warm trend",         mult:[1.10,1.60], weight:50},
      {label:"Melting up (2–3×)",  mult:[2.0,3.0],  weight:20}
    ],
    volScale:0.50,
    posLines:["Tide lifts all","Momentum catches"],
    negLines:["Head fake","Bid thins fast"]
  },

  // Community / Social
  { id:"social-meme", title:"Community — Meme Ripples",
    intro:"A meme template spins up overnight.",
    intensity:{type:"percent", label:"Fan the flames?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"Falls flat",      mult:[0.70,0.98], weight:35},
      {label:"Chuckles only",   mult:[1.02,1.20], weight:40},
      {label:"Meme season (2–4×)", mult:[2.0,4.0], weight:25}
    ],
    volScale:0.60,
    posLines:["Meme detonates","Culture sticks"],
    negLines:["Template tired","Room goes quiet"]
  },
  { id:"social-raid", title:"Community — Coordinated Raid",
    intro:"A community raid forms in TG/CT.",
    intensity:{type:"percent", label:"Amplify or stand back?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"Mod fatigue",  mult:[0.65,0.95], weight:25},
      {label:"Healthy wave", mult:[1.08,1.45], weight:50},
      {label:"Roaring stampede (3–6×)", mult:[3.0,6.0], weight:25}
    ],
    volScale:0.80,
    posLines:["Raid surges","Feeds flood"],
    negLines:["Mods tire","Energy drains"]
  },

  // Partnerships / Ecosystem
  { id:"eco-partner", title:"Ecosystem — Tooling Partnership",
    intro:"A dev-tool partner proposes integration.",
    intensity:{type:"percent", label:"Depth of integration?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"Integration drag", mult:[0.70,0.98], weight:30},
      {label:"Useful lift",      mult:[1.12,1.70], weight:55},
      {label:"Perfect fit (2–3×)", mult:[2.0,3.0], weight:15}
    ],
    volScale:0.45,
    posLines:["Stack clicks","Friction falls"],
    negLines:["Overhead rises","Value unclear"]
  },
  { id:"eco-exchange", title:"Ecosystem — Exchange Spotlight",
    intro:"A mid-tier exchange teases visibility.",
    intensity:{type:"percent", label:"How much to prime listings?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"Tease fizzles",  mult:[0.70,0.98], weight:28},
      {label:"Spotlight day",  mult:[1.15,1.90], weight:52},
      {label:"Headline cycle (3–5×)", mult:[3.0,5.0], weight:20}
    ],
    volScale:0.65,
    posLines:["Ticker everywhere","Order books swell"],
    negLines:["Tease walked back","Eyes move on"]
  },

  // Rare / Moonshots
  { id:"rare-alpha", title:"Rare — Alpha Leak",
    intro:"A respected anon hints at CGT.",
    intensity:{type:"percent", label:"How hard to chase?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"Nothingburger", mult:[0.80,1.00], weight:40},
      {label:"Mini-rip",      mult:[1.10,1.60], weight:40},
      {label:"Alpha stampede (5–10×)", mult:[5.0,10.0], weight:15},
      {label:"Chain reaction (20–50×)", mult:[20.0,50.0], weight:5}
    ],
    volScale:0.95,
    posLines:["Alpha detonates","Chain reaction"],
    negLines:["No follow-through","Timeline shrugs"]
  },
  { id:"rare-crossover", title:"Rare — Mainstream Crossover",
    intro:"A non-crypto brand drops a CGT nod.",
    intensity:{type:"percent", label:"Lean into the crossover?", min:0, max:100, step:5, unit:"%"},
    outcomes:[
      {label:"Misread crowd",  mult:[0.60,0.95], weight:20},
      {label:"Curious audience",mult:[1.12,1.80], weight:55},
      {label:"Lightning bridge (4–8×)", mult:[4.0,8.0], weight:25}
    ],
    volScale:0.85,
    posLines:["Worlds collide","On-chain buzz"],
    negLines:["Audience mismatch","Momentum stalls"]
  }
];

/* ===== DOM ===== */
const elDay=$('#day'), elPrice=$('#price'), elMC=$('#mc');
const elTitle=$('#title'), elDesc=$('#desc'), elControls=$('#controls');
const elIntensityBlock=$('#intensityBlock'), elCommit=$('#commit');
const elOutcomeWrap=$('#outcomeWrap'), elBigMsg=$('#bigMsg'), elOutcomeBox=$('#outcomeBox');
const elNext=$('#next'), elRestart=$('#restart');
const elFlash=$('#flash'), elFlashInner=$('#flashInner');

let scene=null, intensityValue=0, locked=false;

/* ===== HUD ===== */
function updateHUD(){ elDay.textContent=String(day); elPrice.textContent=fmtUSD(price,8); elMC.textContent=fmtUSD(mc()); }

/* ===== Typewriter (slow, human rhythm) ===== */
async function typewrite(el, text, speed=45){
  el.textContent='';
  for(let i=0;i<text.length;i++){ el.textContent += text[i]; await sleep(speed); }
}

/* ===== Clue (blocks; ≥4s + 0.7s buffer) ===== */
async function maybeShowClueBlocking(){
  const p = rand(1/7, 1/4); // ~14–25%
  if(Math.random() < p){
    elFlashInner.textContent = choose([
      "Community buzz rising","Regulatory fog ahead","Infra feels solid",
      "Liquidity thin","Streamer whispers…"
    ]) || "Signal incoming…";
    elFlash.classList.add('show');
    await sleep(4600);                 // full animation duration
    elFlash.classList.remove('show');
    await sleep(700);                  // buffer before title
  }
}

/* ===== Intensity UI ===== */
function renderIntensity(intensity, band){
  elIntensityBlock.innerHTML='';
  const label=document.createElement('div'); label.className='label'; label.textContent=intensity.label;
  const row=document.createElement('div'); row.className='row';
  const left=document.createElement('div'); left.style.fontWeight='900'; left.style.fontSize='18px';
  const right=document.createElement('div'); right.style.flex='1';

  const input=document.createElement('input'); input.type='range';
  input.min=intensity.min; input.max=intensity.max; input.step=intensity.step;

  // Band D default nudge to ≥35%
  if(band.minSnap!=null && intensity.max>intensity.min){
    if(intensity.type==='percent'){ intensityValue = Math.round((band.minSnap*intensity.max)/intensity.step)*intensity.step; }
    else { intensityValue = Math.round((intensity.min + band.minSnap*(intensity.max-intensity.min))/intensity.step)*intensity.step; }
  } else {
    intensityValue = intensity.min;
  }
  input.value=intensityValue;

  const setLabel=()=>{ left.textContent = (intensity.type==='quantity') ? `${intensityValue.toLocaleString()} ${intensity.unit}` : `${intensityValue}${intensity.unit}`; };
  setLabel();
  input.oninput=e=>{ intensityValue=Number(e.target.value); setLabel(); };

  right.appendChild(input); row.appendChild(left); row.appendChild(right);
  elIntensityBlock.appendChild(label); elIntensityBlock.appendChild(row);
}

/* ===== Day flow (robust; never hangs) ===== */
async function newScenario(){
  // reset UI immediately
  elTitle.textContent = "Loading…"; elDesc.textContent = "";
  elControls.style.opacity = 0; elOutcomeWrap.style.display = 'none';
  elBigMsg.textContent = ''; elOutcomeBox.className = 'outcome';
  locked=false;

  // clue first (blocking)
  await maybeShowClueBlocking();

  // safe scene pick
  scene = choose(SCENES);
  if(!scene){
    elTitle.textContent = "CGT Shop";
    elDesc.textContent  = "No scenarios found.";
    return;
  }

  // title animation (1.6s) + 0.7s buffer
  elTitle.style.animation='none'; void elTitle.offsetWidth; elTitle.style.animation=null;
  elTitle.textContent = scene.title;
  await sleep(1600 + 700);

  // build controls (hidden until typewriter finishes)
  const band = volatilityBoost(mc(), START_MC);
  renderIntensity(scene.intensity, band);

  // typewriter intro (first sentence only)
  await typewrite(elDesc, scene.intro, 45);

  // 0.7s after typing → show slider & commit
  await sleep(700);
  elControls.style.opacity = 1;
}

/* ===== Outcome with bands & participation scaling ===== */
function applyOutcome(){
  const intense = scene.intensity;
  const band = volatilityBoost(mc(), START_MC);

  // normalised intensity 0..1
  let norm = 0;
  if(intense.max>intense.min) norm = (intensityValue - intense.min) / (intense.max - intense.min);
  norm = Math.max(0, Math.min(1, norm));

  if(norm===0){ showOutcome(1, true); return; }

  // weight catastrophics more when MC low & user aggressive
  const weightedOutcomes = scene.outcomes.map(o=>{
    let w = o.weight || 1;
    if(o.catastrophic) w *= (band.ex * (norm>0.75?1.8:1.0));
    return {...o, weight:w};
  });
  const bucket = pickWeighted(weightedOutcomes) || scene.outcomes[0];

  // base multiplier sampled, widened by band.mult
  let base = rand(bucket.mult[0], bucket.mult[1]);
  base = 1 + (base - 1) * band.mult;

  // participation blending (20% → ~20% of move)
  let eff = 1 + (base - 1) * norm;

  // scene-specific extra stretch
  const vs = scene.volScale || 0.5;
  eff = (eff>=1) ? 1 + (eff-1)*(1 + vs*norm) : 1 - (1-eff)*(1 + vs*norm);

  // survivability floor unless all-in
  const isAllIn = norm >= 0.999;
  if(!isAllIn) eff = Math.max(eff, band.floor); else eff = Math.max(eff, 0);

  showOutcome(eff, eff>=1);
}

function showOutcome(mult, positive){
  const oldPrice = price; price = price * mult;

  // clear day UI so outcome owns attention
  elTitle.textContent=''; elDesc.textContent=''; elControls.style.opacity=0;

  // big two-line banner
  const lines = positive ? scene.posLines : scene.negLines;
  elBigMsg.className = `bigMsg ${positive?'good':'bad'}`;
  elBigMsg.textContent = (lines && lines.length===2) ? lines.join('\n') : (positive?'Good day':'Bad day');

  // detail box
  elOutcomeWrap.style.display='block';
  const cls = positive ? 'goodBox' : 'badBox';
  elOutcomeBox.className = `outcome ${cls}`;
  const pct = ((mult-1)*100).toFixed(1);
  elOutcomeBox.innerHTML = `
    <div class="big">${positive?'Gain':'Loss'} &nbsp; (${pct>0?'+':''}${pct}%)</div>
    <div>Price: <b>${fmtUSD(oldPrice,8)}</b> → <b>${fmtUSD(price,8)}</b></div>
    <div class="muted">Market Cap: <b>${fmtUSD(oldPrice*SUPPLY)}</b> → <b>${fmtUSD(mc())}</b></div>
  `;

  // end state (only true bust if multiplier ~0)
  if(price<=0.0000000001){ $('#next').style.display='none'; $('#restart').style.display='inline-block'; }
  else { $('#next').style.display='inline-block'; $('#restart').style.display='none'; }

  updateHUD();
}

/* ===== Flow ===== */
function nextDay(){ if(price<=0.0000000001) return; day+=1; updateHUD(); newScenario(); }
function restart(){ day=1; price = 10_000 / SUPPLY; START_MC = price * SUPPLY; updateHUD(); newScenario(); }

/* ===== Init (with guaranteed fallback) ===== */
(function init(){
  updateHUD();

  // Guaranteed fallback if SCENES accidentally empty
  if (!Array.isArray(SCENES)) window.SCENES = [];
  if (SCENES.length === 0) {
    SCENES.push({
      id:"fallback", title:"Marketing — Influencer Thread",
      intro:"A mid-tier influencer offers a thread.",
      intensity:{type:"percent", label:"How hard to support?", min:0, max:100, step:5, unit:"%"},
      outcomes:[{label:"Backlash",mult:[0.6,0.95],weight:40},{label:"Pop",mult:[1.1,1.8],weight:60}],
      volScale:0.5, posLines:["Thread lands","Curiosity spreads"], negLines:["Tone misread","Engagement dips"]
    });
  }

  newScenario();
  $('#commit').addEventListener('click', ()=>{ if(!locked){ locked=true; applyOutcome(); }});
  $('#next').addEventListener('click', nextDay);
  $('#restart').addEventListener('click', restart);
})();
</script>
</body>
</html>
