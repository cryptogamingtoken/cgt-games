<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>CGTShop v0.85</title>
<style>
    :root{
    --bg:#0a0f14;
    --surface:#0f1620;
    --ink:#e6edf3;
    --ink-dim:#9fb0c2;
    --line:#223041;
    --good:#7cf08a;
    --bad:#ff8a8a;
    --hint:#c8d6e5;

    /* GOLD / PURPLE THEME */
    --bold-gold:#F3BD12;
    --cons-purple:#9F6CFF;

    --bold-track:linear-gradient(to right, rgba(243,189,18,.85), rgba(243,189,18,0));
    --cons-track:linear-gradient(to right, rgba(159,108,255,.85), rgba(159,108,255,0));
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    background:var(--bg);
    color:var(--ink);
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;
  }

  /* Header */
  header{
    position:sticky;
    top:0;
    z-index:10;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:12px;
    padding:12px 16px;
    background:rgba(15,22,32,.78);
    backdrop-filter:blur(8px);
    border-bottom:1px solid var(--line);
  }
  .hud{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .pill{
    padding:6px 10px;
    border:1px solid var(--line);
    border-radius:999px;
    white-space:nowrap;
    font-size:13px;
  }
  .k{opacity:.7;margin-right:6px}
  .v{font-weight:700}
  .brand-badge{
    display:inline-flex;
    align-items:center;
    justify-content:center;
    height:38px;
    padding:0 16px;
    border-radius:999px;
    border:1px solid var(--line);
    background:#101a24;
    color:#a7c7ff;
    font-weight:900;
    letter-spacing:.6px;
    font-size:16px;
    box-shadow:0 0 0 2px rgba(42,123,212,.08) inset;
  }

  /* Stage */
  .stage{
    min-height:calc(100% - 70px);
    display:flex;
    align-items:center;
    justify-content:center;
    padding:16px;
  }
  .card{
    width:min(960px,100%);
    min-height:72vh;
    background:linear-gradient(180deg,#0f1620 0%,#0c121a 100%);
    border:1px solid var(--line);
    border-radius:18px;
    padding:20px 14px;
    position:relative;
    overflow:hidden;
    display:flex;
    flex-direction:column;
    justify-content:center;
    align-items:center;
  }

  /* Cinematic headline */
  .headline{
    font-size:clamp(20px,4.2vw,40px);
    font-weight:900;
    letter-spacing:.3px;
    text-align:center;
    margin:0 10px 8px;
    opacity:0;
    transform:translateX(40vw);
    animation:slideAcross 1.6s ease-out forwards;
  }
  @keyframes slideAcross{
    0%{opacity:0;transform:translateX(40vw)}
    15%{opacity:1}
    85%{opacity:1;transform:translateX(-40vw)}
    100%{opacity:1;transform:translateX(0)}
  }
  .type{
    color:var(--ink-dim);
    max-width:820px;
    text-align:center;
    min-height:64px;
    margin:6px 12px 12px;
    white-space:pre-line;
    font-size:14px;
    line-height:1.4;
  }

  /* Panel */
  .panel{
    width:100%;
    max-width:820px;
    margin-top:8px;
  }
  .panel-inner{
    background:#111a27;
    border:1px solid var(--line);
    border-radius:14px;
    padding:14px;
  }
  .row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .btn{
    cursor:pointer;
    border:1px solid var(--line);
    background:#122034;
    color:#e6edf3;
    padding:9px 12px;
    border-radius:10px;
    transition:background .16s, box-shadow .16s, transform .08s;
    font-size:14px;
  }
  .btn:hover{background:#162a43}
  .btn:active{transform:scale(.97)}
  .muted{opacity:.8;font-size:12px}
  .choice-row{
    margin-bottom:10px;
  }
  .btn.choice{
    flex:1 1 140px;
    text-align:center;
    font-weight:700;
  }
    .btn.choice.cons{
    border-color:rgba(159,108,255,.9);
  }
  .btn.choice.bold{
    border-color:rgba(243,189,18,.95);
  }
  .btn.choice.selected{
    box-shadow:0 0 0 2px rgba(255,255,255,.15) inset;
  }

  /* Slider */
  #sliderBlock{
    margin-top:6px;
    display:none;
  }
  .slider-label-row{
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:8px;
    margin-bottom:4px;
  }
  .label{
    opacity:.8;
    font-size:12px;
  }
  .slider-value{
    font-weight:700;
    font-size:13px;
  }
  .sliderWrap{
    width:100%;
  }
  input[type="range"]{
    width:100%;
    -webkit-appearance:none;
    height:6px;
    border-radius:999px;
    background:#182333;
    outline:none;
    margin:8px 0;
  }
  input[type="range"]::-webkit-slider-thumb{
    -webkit-appearance:none;
    appearance:none;
    width:18px;
    height:18px;
    border-radius:50%;
    background:#ffffff;
    border:2px solid #2a7bd4;
    box-shadow:0 0 12px rgba(42,123,212,.6);
    cursor:pointer;
    margin-top:-6px;
  }
  input[type="range"]::-moz-range-thumb{
    width:18px;
    height:18px;
    border-radius:50%;
    background:#ffffff;
    border:2px solid #2a7bd4;
    box-shadow:0 0 12px rgba(42,123,212,.6);
    cursor:pointer;
  }
  input[type="range"]::-webkit-slider-runnable-track{
    height:6px;
    border-radius:999px;
    background:#182333;
  }
  input[type="range"]::-moz-range-track{
    height:6px;
    border-radius:999px;
    background:#182333;
  }

  .card.bold-mode input[type="range"]::-webkit-slider-runnable-track{
    background:var(--bold-track);
  }
  .card.bold-mode input[type="range"]::-moz-range-track{
    background:var(--bold-track);
  }
  .card.cons-mode input[type="range"]::-webkit-slider-runnable-track{
    background:var(--cons-track);
  }
  .card.cons-mode input[type="range"]::-moz-range-track{
    background:var(--cons-track);
  }

  /* Outcome */
  .outcomeWrap{
    display:none;
    width:100%;
    max-width:820px;
    margin-top:10px;
  }
  .bigMsg{
    margin:6px 0 14px;
    padding:14px;
    text-align:center;
    line-height:1.08;
    font-size:clamp(20px,4.4vw,40px);
    font-weight:900;
    letter-spacing:.2px;
    white-space:pre-line;
  }
  .bigMsg.good{color:var(--good)}
  .bigMsg.bad{color:var(--bad)}
  .outcome{
    padding:16px;
    border-radius:12px;
    border:1px solid var(--line);
    text-align:center;
    font-size:14px;
  }
  .goodBox{
    background:#0f1c14;
    border-color:#234333;
    color:var(--good);
  }
  .badBox{
    background:#1c0f10;
    border-color:#432326;
    color:var(--bad);
  }
  .big{
    font-size:clamp(18px,2.6vw,26px);
    font-weight:900;
    margin-bottom:6px;
  }
  .center{
    display:flex;
    justify-content:center;
    gap:10px;
    margin-top:12px;
    flex-wrap:wrap;
  }

  /* Clue overlay */
  .flash{
    position:absolute;
    inset:0;
    display:flex;
    align-items:center;
    justify-content:center;
    color:#d9e6ff;
    font-weight:900;
    text-align:center;
    padding:16px;
    opacity:0;
    pointer-events:none;
    filter:blur(0);
  }
  .flash.show{
    animation:clueIn .4s ease-out forwards,
             clueHold 3.6s linear .4s forwards,
             clueOut .5s ease-in 4s forwards;
  }
  @keyframes clueIn{
    0%{opacity:0;transform:scale(.85);filter:blur(2px)}
    100%{opacity:1;transform:scale(1);filter:blur(0)}
  }
  @keyframes clueHold{
    0%{opacity:1}
    100%{opacity:1}
  }
  @keyframes clueOut{
    0%{opacity:1}
    100%{opacity:0;transform:scale(1.03)}
  }
  .flashInner{
    background:rgba(7,11,16,.90);
    border:1px solid #2a7bd4;
    border-radius:16px;
    padding:18px 22px;
    font-size:clamp(18px,3.8vw,32px);
    box-shadow:0 0 0 2px rgba(42,123,212,.15) inset;
  }

  /* Bias HUD */
  .bias-hud{
    position:fixed;
    inset:auto 12px 12px auto;
    max-width:240px;
    padding:10px 12px;
    border-radius:12px;
    border:1px solid rgba(95,134,210,.8);
    background:rgba(7,12,20,.96);
    color:#dbe5ff;
    font-size:12px;
    box-shadow:0 10px 28px rgba(0,0,0,.5);
    backdrop-filter:blur(8px);
    z-index:20;
    display:none;
  }
  .bias-hud-header{
    font-weight:700;
    margin-bottom:4px;
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:6px;
  }
  .bias-hud-header span{font-size:13px;}
  .bias-value{
    font-weight:700;
    font-size:13px;
  }
  #biasSlider{
    width:100%;
    margin-top:6px;
  }
  .meta{
    margin-top:2px;
  }

  @media (min-width:768px){
    .panel-inner{
      padding:16px 18px;
    }
    .btn{
      font-size:14px;
    }
  }
  /* ==========================================
   Enhanced Path UI (Cinematic)
========================================== */

.path-title {
  font-size: clamp(22px, 4vw, 38px);
  font-weight: 900;
  text-align: center;
  margin: 4px 0 6px;
  position: relative;
  letter-spacing: .3px;
  opacity: 0;
  transform: translateY(-10px);
  animation: fadeInUp .45s ease-out forwards;
}

.path-desc {
  text-align: center;
  font-size: 14px;
  margin: 0 auto 12px;
  line-height: 1.45;
  opacity: 0;
  transform: translateY(4px);
  animation: fadeInUp .45s ease-out .1s forwards;
  max-width: 700px;
  white-space: normal;
}

/* ‚ö° Lightning for Bold 
.path-title.bold::before {
  content: "‚ö°Ô∏è";
  font-size: 26px;
  position: absolute;
  left: -38px;
  top: 2px;
  opacity: .9;
}

/* üõ°Ô∏è Shield for Conservative */
.path-title.cons::before {
  content: "üõ°Ô∏è";
  font-size: 23px;
  position: absolute;
  left: -38px;
  top: 3px;
  opacity: .9;
} */

/* Cinematic gradient underline */
.path-title::after {
  content:"";
  position:absolute;
  left:50%;
  bottom:-6px;
  transform:translateX(-50%);
  width: 60%;
  height: 3px;
  border-radius: 999px;
}

.path-title.bold::after {
  background: linear-gradient(90deg,
    rgba(243,189,18,0) 0%,
    rgba(243,189,18,1) 50%,
    rgba(243,189,18,0) 100%
  );
}

.path-title.cons::after {
  background: linear-gradient(90deg,
    rgba(159,108,255,0) 0%,
    rgba(159,108,255,1) 50%,
    rgba(159,108,255,0) 100%
  );
}

.path-title.bold {
  color: var(--bold-gold);
}

.path-title.cons {
  color: var(--cons-purple);
}

@keyframes fadeInUp {
  0% { opacity:0; transform:translateY(10px); }
  100% { opacity:1; transform:translateY(0); }
}
/* ======================================
   Outcome ‚Äî Cinematic Header
====================================== */

.outcome-title {
  font-size: clamp(20px, 3.8vw, 34px);
  font-weight: 900;
  text-align: center;
  margin-bottom: 6px;
  animation: fadeInUp .45s ease-out forwards;
}

/* BOLD PATH ‚Äî lightning + gold */
.outcome-title.bold {
  color: #F3BD12 !important;
}

/* CONSERVATIVE PATH ‚Äî shield + purple */
.outcome-title.conservative {
  color: #9f6cff !important;
}

.outcome-sub {
  font-size: clamp(16px, 3vw, 26px);
  font-weight: 700;
  text-align: center;
  opacity: 0;
  animation: fadeInUp .45s ease-out .08s forwards;
}

.outcome-sub.good {
  color: var(--good);
}
.outcome-sub.bad {
  color: var(--bad);
}

.outcome-desc {
  margin-top: 12px;
  max-width: 740px;
  margin-left: auto;
  margin-right: auto;
  font-size: 14px;
  text-align: center;
  color: var(--ink-dim);
  line-height: 1.45;
  opacity: 0;
  animation: fadeInUp .45s ease-out .18s forwards;
}
  /* ======================================================
   Dynamic Slider Theme (Bold ‚Üî Conservative)
   ====================================================== */

/* Main slider transition container */
.sliderWrap input[type="range"] {
  transition: all 0.45s ease-in-out;
}

/* ===========================
   TRACK gradients
   =========================== */

/* Conservative = fade to the LEFT (purple) */
.card.cons-mode input[type="range"]::-webkit-slider-runnable-track {
  background: linear-gradient(to left,
    rgba(159,108,255,0.9),
    rgba(159,108,255,0)
  );
}
.card.cons-mode input[type="range"]::-moz-range-track {
  background: linear-gradient(to left,
    rgba(159,108,255,0.9),
    rgba(159,108,255,0)
  );
}

/* Bold = fade to the LEFT (gold) */
.card.bold-mode input[type="range"]::-webkit-slider-runnable-track {
  background: linear-gradient(to left,
    rgba(243,189,18,0.9),
    rgba(243,189,18,0)
  );
}
.card.bold-mode input[type="range"]::-moz-range-track {
  background: linear-gradient(to left,
    rgba(243,189,18,0.9),
    rgba(243,189,18,0)
  );
}

/* ===========================
   THUMB colors
   =========================== */

/* Conservative thumb = purple */
.card.cons-mode input[type="range"]::-webkit-slider-thumb {
  background: var(--cons-purple);
}
.card.cons-mode input[type="range"]::-moz-range-thumb {
  background: var(--cons-purple);
}

/* Bold thumb = gold */
.card.bold-mode input[type="range"]::-webkit-slider-thumb {
  background: var(--bold-gold);
}
.card.bold-mode input[type="range"]::-moz-range-thumb {
  background: var(--bold-gold);
}

/* ===========================
   CARD glow animation
   =========================== */
.card {
  transition: box-shadow 0.45s ease-in-out;
}

.card.bold-mode {
  box-shadow: 0 0 24px rgba(243,189,18,0.33);
}

.card.cons-mode {
  box-shadow: 0 0 24px rgba(159,108,255,0.33);
}
/* Completely remove title/desc space during outcome */
.vanish {
  display: none !important;
  margin: 0 !important;
  padding: 0 !important;
  height: 0 !important;
  min-height: 0 !important;
}
.card.outcome-mode {
  justify-content: flex-start !important;
  padding-top: 40px !important;
  padding-bottom: 40px !important;
  min-height: auto !important;
}
/* ================================
   Fix spacing when showing outcome
   ================================ */

.stage:has(.outcome-mode) {
  align-items: flex-start !important;
  padding-top: 40px !important;
}
.stage.outcome-shift {
  align-items: flex-start !important;
  padding-top: 32px !important;
}
/* ===========================================
   PREMIUM PACK ‚Äî CINEMATIC UPGRADES
   =========================================== */

/* 1. Tighter vertical spacing */
.outcome-title {
  margin-top: 4px !important;
  margin-bottom: 2px !important;
}

.outcome-sub {
  margin-top: 0 !important;
  margin-bottom: 4px !important;
}

.outcome-desc {
  margin-top: 8px !important;
}

/* 2. Fade + scale animation for the whole outcome box */
#outcomeWrap {
  opacity: 0;
  transform: scale(0.94);
  transition: opacity .45s ease-out, transform .45s ease-out;
}

/* Activated state */
#outcomeWrap.show {
  opacity: 1;
  transform: scale(1);
}

/* 3. Dynamic glow behind the entire card */
.card.outcome-mode.bold {
  box-shadow: 0 0 38px rgba(243,189,18,0.26) !important;
}

.card.outcome-mode.cons {
  box-shadow: 0 0 38px rgba(159,108,255,0.26) !important;
}

/* 4. Slightly lift the result box for better composition */
.outcome {
  margin-top: 14px !important;
}

/* 5. Reduce dead-space at top of outcome view */
.card.outcome-mode {
  padding-top: 28px !important;
}
/* Custom icons for Bold (‚ö°) and Conservative (üõ°Ô∏è) */
.icon-bold {
  color: #F3BD12;
  margin-right: 6px;
}

.icon-cons {
  color: #9F6CFF;
  margin-right: 6px;
}
html, body {
  overflow-x: hidden !important;
  width: 100% !important;
  max-width: 100% !important;
}

.card {
  overflow-x: hidden !important;
}
</style>
</head>
<body>
  <!-- setting @ stakeholder data -->
<script src="cgtshop-tuning.js"></script>
<script src="founder-data.js"></script>
  
  <header>
    <div class="hud">
      <div class="pill"><span class="k">Day</span><span class="v" id="day">1</span></div>
      <div class="pill"><span class="k">Price</span><span class="v" id="price">$0.00002857</span></div>
      <div class="pill"><span class="k">Market Cap</span><span class="v" id="mc">$10,000</span></div>
    </div>
    <span class="brand-badge">CGT</span>
  </header>

  <main class="stage">
    <section class="card" id="card">
      <div id="flash" class="flash"><div id="flashInner" class="flashInner">Signal‚Ä¶</div></div>

      <h1 id="title" class="headline">Loading‚Ä¶</h1>
      <p id="desc" class="type"></p>

      <div id="controls" class="panel" style="opacity:0;">
        <div class="panel-inner">
          <div class="row choice-row" id="choiceRow">
            <button id="consBtn" class="btn choice cons">Conservative path</button>
            <button id="boldBtn" class="btn choice bold">Bold path</button>
          </div>

          <div id="sliderBlock"></div>

          <div class="row" id="commitRow" style="margin-top:10px; display:none;">
            <button id="commit" class="btn">Commit decision</button>
            <button id="changeMind" class="btn">Change Mind üß†</button>
          </div>
          <div class="muted" id="hintRow" style="margin-top:4px;display:none;">
            Adjust your multiplier, then commit. Change your mind if you want to pick the other path.
          </div>
        </div>
      </div>

      <div id="outcomeWrap" class="outcomeWrap">
        <div id="bigMsg" class="bigMsg"></div>
        <div id="outcomeBox" class="outcome"></div>
        <div class="center">
          <button id="next" class="btn">Next day</button>
          <button id="restart" class="btn" style="display:none;">Restart</button>
        </div>
      </div>
    </section>
  </main>

  <!-- Bias HUD -->
  <div id="biasHUD" class="bias-hud">
    <div class="bias-hud-header">
      <span>üé≤ Favourable bias</span>
      <span id="biasValue" class="bias-value">80%</span>
    </div>
    <!-- TEST MODE TOGGLE -->
<div style="margin-bottom:8px;">
  <label style="display:flex;align-items:center;gap:6px;cursor:pointer;">
    <input type="checkbox" id="testModeToggle" style="transform:scale(1.2);">
    <span><b>Test Mode</b> ‚Äî use slider probability</span>
  </label>
</div>
    <input type="range" id="biasSlider" min="10" max="90" step="5" value="80">
    <div class="muted" style="margin-top:4px;">Two-finger tap (or press ‚ÄúB‚Äù) to toggle this during testing.</div>
    <div class="meta"><b>Ref:</b> <span id="metaRef">‚Äî</span></div>
    <div class="meta"><b>Tone:</b> <span id="metaTone">‚Äî</span></div>
    <div class="meta"><b>MC:</b> <span id="metaMC">‚Äî</span></div>
  </div>

  
<script>
/* ========= Test Mode ========= */
window.TEST_MODE = false;

document.addEventListener('DOMContentLoaded', () => {
  const tgl = document.querySelector('#testModeToggle');
  if (tgl) {
    tgl.addEventListener('change', e => {
      window.TEST_MODE = e.target.checked;
    });
  }
});

/* ========= Core state ========= */
const SUPPLY = 350_000_000;
let day = 1;
let price = 10_000 / SUPPLY;
let bias = 80;          // default 80% favourable
let locked = false;
let chosenPath = null;  // 'bold' or 'conservative'
let sliderInput = null;
let hasOutcomeShown = false;
let currentScenario = null;

function mc(){ return price * SUPPLY; }
function fmtUSD(n, d=8){
  const o = {
    minimumFractionDigits:(n<1?d:2),
    maximumFractionDigits:(n<1?d:2)
  };
  return '$'+n.toLocaleString(undefined,o);
}

/* ========= Utilities ========= */
const $ = s => document.querySelector(s);
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function rand(min,max){ return Math.random()*(max-min)+min; }

/* ========= DOM ========= */
const elDay = $('#day');
const elPrice = $('#price');
const elMC = $('#mc');
const elTitle = $('#title');
const elDesc = $('#desc');
const elControls = $('#controls');
const elOutcomeWrap = $('#outcomeWrap');
const elBigMsg = $('#bigMsg');
const elOutcomeBox = $('#outcomeBox');
const elNext = $('#next');
const elRestart = $('#restart');
const elFlash = $('#flash');
const elFlashInner = $('#flashInner');
const elCard = $('#card');

const elConsBtn = $('#consBtn');
const elBoldBtn = $('#boldBtn');
const elChoiceRow = $('#choiceRow');
const elSliderBlock = $('#sliderBlock');
const elCommitRow = $('#commitRow');
const elHintRow = $('#hintRow');
const elCommit = $('#commit');
const elChangeMind = $('#changeMind');

const elBiasHUD = $('#biasHUD');
const elBiasSlider = $('#biasSlider');
const elBiasValue = $('#biasValue');
const elMetaRef = $('#metaRef');
const elMetaTone = $('#metaTone');
const elMetaMC = $('#metaMC');

/* ========= Data ========= */
let founderScenarios = (window.CGT_SCENARIOS && window.CGT_SCENARIOS.founder) || [];
if (!Array.isArray(founderScenarios) || founderScenarios.length === 0){
  founderScenarios = [{
    subBand:'F-B1-0.1',
    marketCap:'$10 K',
    focus:'First spark',
    context:'Barely off the ground; prototype exists, but nobody‚Äôs watching.',
    tone:'risky',
    outcomeA:'Early adopters rally behind the MVP, posting screenshots and feedback that spark a viral micro-wave of credibility.',
    outcomeB:'Launch exposes half-finished systems; bugs and confusion dominate the narrative, causing early trust erosion.',
    outcomeC:'A few testers privately confirm the build‚Äôs strength; quiet progress builds word-of-mouth trust.',
    outcomeD:'Delays frustrate insiders who drift away, leaving the project isolated before momentum forms.'
  }];
}

/* ==== Ref MC helpers ==== */
function parseRefMC(str){
  if(!str) return 0;
  const m = String(str).replace('+','').trim().match(/([\d.]+)\s*([KMB])/i);
  if(!m) return 0;
  const v = parseFloat(m[1]);
  const u = m[2].toUpperCase();
  const mul = u==='K'?1e3:u==='M'?1e6:1e9;
  return v*mul;
}
function pickScenarioForMC(curMC, list){
  let best = null, bestDiff = Infinity;
  for(const s of list){
    const ref = parseRefMC(s.marketCap);
    if(!ref) continue;
    const diff = Math.abs(ref - curMC);
    if(diff < bestDiff){
      bestDiff = diff;
      best = s;
    }
  }
  return best || list[0];
}

/* ========= HUD ========= */
function updateHUD(){
  elDay.textContent = String(day);
  elPrice.textContent = fmtUSD(price,8);
  elMC.textContent = fmtUSD(mc());
}

/* ========= Typewriter ========= */
async function typewrite(el, text, speed=28){
  el.textContent = '';
  for(let i=0;i<text.length;i++){
    el.textContent += text[i];
    await sleep(speed);
  }
}

/* ========= Clue overlay ========= */
async function maybeShowClueBlocking(){
  const p = rand(1/7, 1/4);
  if (Math.random() < p){
    const msgs = [
      "Community buzz rising",
      "Regulatory fog ahead",
      "Infra feels solid",
      "Liquidity thin",
      "Streamer whispers‚Ä¶"
    ];
    elFlashInner.textContent = msgs[Math.floor(Math.random()*msgs.length)] || "Signal incoming‚Ä¶";
    elFlash.classList.add('show');
    await sleep(4600);
    elFlash.classList.remove('show');
    await sleep(700);
  }
}

/* ========= Bands ‚Üí slider ranges ========= */
function getBandRange(subBand, path){
  const T = window.CGT_TUNING;

  if (path === 'conservative'){
    return {
      min: T.sliders.conservative.min,
      max: T.sliders.conservative.max,
      step: T.sliders.conservative.step
    };
  }

  const parts = (subBand || '').split('-');
  const bandCode = parts[1] || '';
  const max = T.boldBandCaps[bandCode] || 3.0;

  return {
    min: T.sliders.bold.min,
    max,
    step: T.sliders.bold.step
  };
}


/* ========= Slider rendering ========= */
function renderSlider(range, path){
  elSliderBlock.innerHTML = '';

  const labelRow = document.createElement('div');
  labelRow.className = 'slider-label-row';

  const lbl = document.createElement('div');
  lbl.className = 'label';
  lbl.textContent = 'Risk multiplier';

  const val = document.createElement('div');
  val.className = 'slider-value';
  val.id = 'sliderValue';

  labelRow.appendChild(lbl);
  labelRow.appendChild(val);

  const wrap = document.createElement('div');
  wrap.className = 'sliderWrap';

  const input = document.createElement('input');
  input.type = 'range';
  input.min = range.min;
  input.max = range.max;
  input.step = range.step;
  input.value = range.min;

  const updateLabel = () => {
    const v = parseFloat(input.value || range.min);
    val.textContent = v.toFixed(1) + '√ó';
  };
  input.addEventListener('input', updateLabel);
  updateLabel();
  wrap.appendChild(input);

  // Tap-anywhere-to-set slider value
  wrap.addEventListener('click', (e) => {
    if (e.target === input) return; // native drag

    const rect = input.getBoundingClientRect();
    let ratio = (e.clientX - rect.left) / rect.width;

    if (ratio < 0) ratio = 0;
    if (ratio > 1) ratio = 1;

    if (path === 'conservative') {
      ratio = 1 - ratio; // mirrored visually
    }

    const min = parseFloat(range.min);
    const max = parseFloat(range.max);
    const step = parseFloat(range.step);

    let value = min + ratio * (max - min);

    if (step > 0) {
      value = Math.round(value / step) * step;
    }

    input.value = value.toFixed(1);
    updateLabel();

    const evt = new Event('input', { bubbles: true });
    input.dispatchEvent(evt);
  });

  if (path === 'conservative'){
    wrap.style.transform = 'scaleX(-1)';
  } else {
    wrap.style.transform = 'none';
  }

  elSliderBlock.appendChild(labelRow);
  elSliderBlock.appendChild(wrap);

  elSliderBlock.style.display = 'block';
  elCommitRow.style.display = 'flex';
  elHintRow.style.display = 'block';

  // Button order: conservative = Commit | Change, bold = Change | Commit
  elCommitRow.style.flexDirection = (path === 'bold') ? 'row-reverse' : 'row';

  sliderInput = input;
}

/* ========= Decision UI ========= */
function resetDecisionUI(){
  chosenPath = null;

  elConsBtn.classList.remove('selected');
  elBoldBtn.classList.remove('selected');
  elChoiceRow.style.display = 'flex';
  elSliderBlock.style.display = 'none';
  elCommitRow.style.display = 'none';
  elHintRow.style.display = 'none';
  sliderInput = null;
  elCard.classList.remove('bold-mode','cons-mode');

  if (currentScenario) {
    elTitle.className = 'headline';
    elTitle.textContent = `Founders ¬∑ ${currentScenario.focus || ''}`;

    elDesc.className = 'type';
    elDesc.textContent = currentScenario.context || '';
  }
}

function choosePath(path, range){
  chosenPath = path;
  elChoiceRow.style.display = 'none';

  if (path === 'bold'){
    elBoldBtn.classList.add('selected');
    elConsBtn.classList.remove('selected');
    elCard.classList.add('bold-mode');
    elCard.classList.remove('cons-mode');
  } else {
    elConsBtn.classList.add('selected');
    elBoldBtn.classList.remove('selected');
    elCard.classList.add('cons-mode');
    elCard.classList.remove('bold-mode');
  }

  if (currentScenario) {
    elTitle.classList.remove('headline');
    elTitle.className = 'path-title ' + (path === 'bold' ? 'bold' : 'cons');

    elTitle.textContent = path === 'bold'
      ? "Bold Path"
      : "Conservative Path";

    elDesc.className = 'path-desc';
    elDesc.textContent = path === 'bold'
      ? currentScenario.boldPrompt || ""
      : currentScenario.conservativePrompt || "";
  }

  renderSlider(range, path);
}

/* ========= New scenario ========= */
async function newScenario(){
  locked = false;
  hasOutcomeShown = false;
  resetDecisionUI();

  elOutcomeWrap.style.display = 'none';
  elOutcomeWrap.classList.remove('show');
  elTitle.textContent = 'Loading‚Ä¶';
  elDesc.textContent = '';

  elControls.style.display = 'block';
  elControls.style.opacity = 0;

  await maybeShowClueBlocking();

  currentScenario = pickScenarioForMC(mc(), founderScenarios);
  const s = currentScenario;

  elTitle.style.animation = 'none';
  void elTitle.offsetWidth;
  elTitle.style.animation = null;

  const titleText = `Founders ¬∑ ${s.focus || 'Founder Scenario'}`;
  elTitle.textContent = titleText;

  await sleep(1600 + 250);

  await typewrite(elDesc, s.context || '', 26);

  if (elMetaRef)  elMetaRef.textContent  = s.subBand || '‚Äî';
  if (elMetaTone) elMetaTone.textContent = s.tone || '‚Äî';
  if (elMetaMC)   elMetaMC.textContent   = s.marketCap || '‚Äî';

  await sleep(250);
  elControls.style.opacity = 1;

  elConsBtn.onclick = () => choosePath('conservative', getBandRange(s.subBand, 'conservative'));
  elBoldBtn.onclick = () => choosePath('bold', getBandRange(s.subBand, 'bold'));
}

/* ========= Outcome logic ========= */
function resolveDecision(){
  if (locked) return;
  if (!currentScenario) return;

  if (!chosenPath){
    alert('Choose Conservative or Bold first.');
    return;
  }
  if (!sliderInput){
    alert('Set your multiplier before committing.');
    return;
  }

  const range = getBandRange(currentScenario.subBand, chosenPath);
  let mult = parseFloat(sliderInput.value || range.min);
  mult = Math.max(range.min, Math.min(range.max, mult));

  let isFavourable;

  /* ======================================================
   FINAL PROBABILITY LOGIC ‚Äî v0.85 (Tuning-based)
====================================================== */

const T = window.CGT_TUNING;

if (window.TEST_MODE){
  isFavourable = Math.random() < (bias / 100);
}
else if (chosenPath === 'conservative'){
  
  const frac = (mult - T.sliders.conservative.min) /
               (T.sliders.conservative.max - T.sliders.conservative.min);

  let slice = Math.floor(frac * T.conservativeProbabilities.slices);
  slice = Math.max(0, Math.min(T.conservativeProbabilities.slices - 1, slice));

  const p = T.conservativeProbabilities.percents[slice] / 100;
  isFavourable = Math.random() < p;
}
else {
  // bold
  const frac = (mult - T.sliders.bold.min) /
               (T.boldLoss.wipeoutEndMult - T.sliders.bold.min);

  let slice = Math.floor(frac * T.boldProbabilities.slices);
  slice = Math.max(0, Math.min(T.boldProbabilities.slices - 1, slice));

  const step = (T.boldProbabilities.start - T.boldProbabilities.end) /
               (T.boldProbabilities.slices - 1);

  const p = (T.boldProbabilities.start - slice * step) / 100;
  isFavourable = Math.random() < p;
}

  const s = currentScenario;
  let outcomeText = '';

  if (chosenPath === 'bold'){
    outcomeText = isFavourable ? (s.outcomeA || '') : (s.outcomeB || '');
  } else {
    outcomeText = isFavourable ? (s.outcomeC || '') : (s.outcomeD || '');
  }

  applyOutcome(isFavourable, mult, outcomeText, s);
  locked = true;
}

/* ========= Apply Outcome =========
   Conservative mult (0.1‚Äì0.8) = ¬±10‚Äì80% change
   Bold mult (>=1.1) = direct √ó multiplier
==================================== */
function applyOutcome(isFavourable, multDisplayed, text, scenario){
  const oldMC = mc();
  const mult = multDisplayed;
  let newMC = oldMC;
  let tierUsed = null;   // 2 / 5 / 10 / 25 for UI

  if (isFavourable){

    if (chosenPath === 'conservative') {
      // magnitude of change: 0.1 ‚Üí 10%, 0.8 ‚Üí 80%
      const changePct = mult;
      const baseGain = oldMC * changePct;

      // slice index 0‚Äì7
      const frac = (mult - 0.10) / 0.70;
      let sliceIndex = Math.floor(frac * 8);
      sliceIndex = Math.max(0, Math.min(7, sliceIndex));

    /* === Jackpot logic from tuning file === */
const JC = window.CGT_TUNING.jackpotConservative;

const sliceCount = JC.chances.length;
const frac2 = (mult - 0.10) / 0.70;
let i = Math.floor(frac2 * sliceCount);
i = Math.max(0, Math.min(sliceCount - 1, i));

const chance = JC.chances[i];
const roll = Math.random() * 100;

if (roll < chance){
  const tierRoll = Math.random() * 100;
  let tier = 2;
  if (tierRoll < JC.distribution[25]) tier = 25;
  else if (tierRoll < JC.distribution[25] + JC.distribution[10]) tier = 10;
  else if (tierRoll < JC.distribution[25] + JC.distribution[10] + JC.distribution[5]) tier = 5;
  else tier = 2;

  tierUsed = tier;

  const bonus = baseGain * tier;
  newMC = oldMC + baseGain + bonus;
} else {
  newMC = oldMC + baseGain;
}

    } else {
      // Bold favourable: direct multiplier
      newMC = oldMC * mult;
    }

  } else {
    // UNFAVOURABLE

    if (chosenPath === 'bold') {
      if (mult < 2.0){
        const remaining = (2.0 - mult);
        newMC = oldMC * remaining;
      } } else {
  /* ===========================================================
     BOLD LOSS ‚Äî Tuning-driven wipeout curve (from tuning file)
  ============================================================ */
  const L = window.CGT_TUNING.boldLoss;

  const t = (mult - L.wipeoutStartMult) /
            (L.wipeoutEndMult - L.wipeoutStartMult);

  const tt = Math.max(0, Math.min(1, t));

  const loss = L.startLoss + (L.endLoss - L.startLoss) * tt;

  const remaining = Math.max(0, 1 - loss);

  newMC = oldMC * remaining;
}
    } else {
      // Conservative symmetrical loss: -10% ‚Ä¶ -80%
      const lossPct = mult;
      newMC = oldMC * (1 - lossPct);
    }
  }

  // Safety clamps
  if (!isFinite(newMC) || newMC < 0) newMC = 0;

  price = newMC / SUPPLY;
  if (!isFinite(price) || price < 0) price = 0;

  showOutcome(isFavourable, multDisplayed, text, scenario, oldMC, newMC, tierUsed);
}

/* ========= Show Outcome ========= */
function showOutcome(isFavourable, mult, text, scenario, oldMC, newMC, tierUsed){
  hasOutcomeShown = true;
/* ===== RESET GOLD MODE BEFORE APPLYING ANY NEW STYLING ===== */
elOutcomeBox.style.borderColor = "";
elOutcomeBox.style.color = "";
elOutcomeBox.style.background = "";

elBigMsg.style.color = "";

  // Realised change from MC, not slider
  const mcDiff = newMC - oldMC;
  const pctChange = oldMC === 0 ? 0 : (mcDiff / oldMC) * 100;
  const isGain = mcDiff >= 0;
  const pctStr = (isGain ? "+" : "") + pctChange.toFixed(0) + "%";

  const isJackpot = isGain && !!tierUsed;

  // UI state
  elTitle.classList.add('vanish');
  elDesc.classList.add('vanish');
  elCard.classList.add('outcome-mode');

  if (chosenPath === 'bold') {
    elCard.classList.add('bold');
    elCard.classList.remove('cons');
  } else {
    elCard.classList.add('cons');
    elCard.classList.remove('bold');
  }

  elControls.style.opacity = 0;
  elControls.style.display = 'none';

  elOutcomeWrap.style.display = 'block';
  requestAnimationFrame(() => {
    elOutcomeWrap.classList.add('show');
  });

  // Header + colours
  elBigMsg.className = 'bigMsg ' + (isGain ? 'good' : 'bad');

  const headerTitle =
    chosenPath === 'bold'
      ? '<span class="icon-bold">‚ö°</span> Bold Path'
      : '<span class="icon-cons">üõ°Ô∏è</span> Conservative Path';

  let headerOutcome;
  if (!isGain) {
    headerOutcome = 'Unfavourable Outcome';
  } else {
    headerOutcome = isJackpot
      ? `${tierUsed}√ó Favourable Outcome`
      : 'Favourable Outcome';
  }

  elBigMsg.innerHTML = `
    <div class="outcome-title ${chosenPath}">
      ${headerTitle}
    </div>
    <div class="outcome-sub ${isGain ? 'good' : 'bad'}">
      ${headerOutcome}
    </div>
    <div class="outcome-desc">${text}</div>
  `;

  // MC / price lines
  const priceLine =
    `Price: <b>${fmtUSD(oldMC / SUPPLY, 8)}</b> ‚Üí <b>${fmtUSD(newMC / SUPPLY,8)}</b>`;

  const mcLine =
    `Market Cap: <b>${fmtUSD(oldMC)}</b> ‚Üí <b>${fmtUSD(newMC)}</b>`;

  const focusLine =
    scenario ? `<div class="muted" style="margin-top:10px;">${scenario.focus || ''}</div>` : '';

  elOutcomeBox.className = 'outcome ' + (isGain ? 'goodBox' : 'badBox');

  elOutcomeBox.innerHTML = `
    <div class="big">${isGain ? 'Gain' : 'Loss'} &nbsp; (${pctStr})</div>
    <div>${priceLine}</div>
    <div class="muted">${mcLine}</div>
    ${focusLine}
  `;

  // GOLD jackpot styling (only on gain + tierUsed)
  if (isJackpot){
    const titleEl = elBigMsg.querySelector('.outcome-title');
    const subEl = elBigMsg.querySelector('.outcome-sub');

    if (titleEl) titleEl.style.color = '#F3BD12';
    if (subEl) subEl.style.color = '#F3BD12';

    elOutcomeBox.style.borderColor = '#F3BD12';
    elOutcomeBox.style.color = '#F3BD12';
    elOutcomeBox.style.background = '#1c1505';
  }

  if (newMC <= 0){
    elNext.style.display = 'none';
    elRestart.style.display = 'inline-block';
  } else {
    elNext.style.display = 'inline-block';
    elRestart.style.display = 'none';
  }

  updateHUD();
}

/* ========= Flow ========= */
function nextDay(){
  if (price <= 0) return;
  elOutcomeWrap.classList.remove('show');
  elTitle.classList.remove('vanish');
  elDesc.classList.remove('vanish');
  elCard.classList.remove('outcome-mode');
  document.querySelector('.stage').classList.remove('outcome-shift');
  day += 1;
  updateHUD();
  newScenario();
}

function restartGame(){
  elOutcomeWrap.classList.remove('show');
  elTitle.classList.remove('vanish');
  elDesc.classList.remove('vanish');
  elCard.classList.remove('outcome-mode');
  document.querySelector('.stage').classList.remove('outcome-shift');
  day = 1;
  price = 10_000 / SUPPLY;
  updateHUD();
  newScenario();
}

/* ========= Bias HUD ========= */
function updateBiasFromSlider(){
  bias = parseInt(elBiasSlider.value,10) || 80;
  elBiasValue.textContent = bias + '%';
}

function toggleBiasHUD(){
  if (elBiasHUD.style.display === 'block'){
    elBiasHUD.style.display = 'none';
  } else {
    elBiasHUD.style.display = 'block';
  }
}

/* ========= Init ========= */
(function init(){
  updateHUD();
  updateBiasFromSlider();

  elBiasSlider.addEventListener('input', updateBiasFromSlider);

  elCommit.addEventListener('click', resolveDecision);
  elChangeMind.addEventListener('click', ()=>{ if(!locked) resetDecisionUI(); });
  elNext.addEventListener('click', nextDay);
  elRestart.addEventListener('click', restartGame);

  // Tap-card to go next day once outcome is shown
  elCard.addEventListener('click', e => {
    if (!hasOutcomeShown) return;
    if (e.target.closest('.panel-inner') || e.target.closest('.btn') || e.target.closest('#biasHUD')) return;
    nextDay();
  });

  // Two-finger tap to toggle bias HUD (mobile)
  document.addEventListener('touchstart', e => {
    if (e.touches && e.touches.length >= 2){
      e.preventDefault();
      toggleBiasHUD();
    }
  }, {passive:false});

  // 'b' key toggles bias HUD (desktop testing)
  document.addEventListener('keydown', e => {
    if (e.key === 'b' || e.key === 'B'){
      toggleBiasHUD();
    }
  });

  newScenario();
})();
</script>
</body>
</html>
