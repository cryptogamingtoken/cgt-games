<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>CGT • Dev L0 — Leaderboard (Mock MVP)</title>
<style>
  :root{
    --bg:#0b0f14; --ink:#eaf2ff; --muted:#9fb3cc;
    --panel:#0f1621; --line:#233247;
    --good:#5ee1a2; --warn:#69b0ff; --bad:#ff6b6b; --btn:#162130;
    --pill:#101828; --pillBr:#26354a;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:linear-gradient(180deg,#0b0f14,#0e141c);color:var(--ink);
       font:15px/1.45 ui-sans-serif,system-ui,-apple-system,"Segoe UI",Inter,Roboto,Arial}
  header{position:sticky;top:0;z-index:5;padding:.8rem 1rem;background:rgba(11,15,20,.82);
    backdrop-filter:saturate(140%) blur(10px);border-bottom:1px solid #17202b;display:flex;gap:.75rem;align-items:center;flex-wrap:wrap}
  .brand{font-weight:800}
  .hud{margin-left:auto;display:flex;gap:.5rem;flex-wrap:wrap}
  .pill{padding:.25rem .55rem;border:1px solid var(--pillBr);border-radius:999px;background:var(--pill);color:var(--muted);font-size:.86rem}
  .pill strong{color:var(--ink)}
  main{max-width:720px;margin:0 auto;padding:1rem .9rem 4rem;display:grid;gap:1rem}
  .card{background:linear-gradient(180deg,#182435,#131b28);border:1px solid #223249;border-radius:16px;box-shadow:0 18px 40px rgba(0,0,0,.45);padding:1rem}
  .title{font-weight:900;margin:.1rem 0 .5rem}
  .row{display:flex;gap:.5rem;flex-wrap:wrap;align-items:center}
  .btn{appearance:none;border:1px solid #25405c;background:#0f1621;color:#fff;border-radius:12px;padding:.65rem .9rem;font-weight:800;cursor:pointer}
  .btn.primary{background:linear-gradient(180deg,#27c59b,#119a7a);border-color:#0d8066}
  .btn.danger{background:linear-gradient(180deg,#c94b51,#972d34);border-color:#7d2228}
  .btn.ghost{background:#101828}
  .grid{display:grid;gap:.75rem}
  @media(min-width:640px){ .grid{grid-template-columns:1fr} }
  .kv{display:grid;grid-template-columns:120px 1fr;gap:.35rem .75rem}
  .lb{width:100%;border-collapse:collapse;border-spacing:0}
  .lb th,.lb td{padding:.55rem .5rem;border-bottom:1px solid #223249;text-align:left;font-size:.95rem}
  .lb th{color:#a9bfd8;font-weight:700}
  .lb .ok{color:var(--good)} .lb .warn{color:var(--warn)} .lb .bad{color:var(--bad)}
  .k{color:#a9bfd8}
  .actions{display:grid;grid-template-columns:1fr 1fr;gap:.6rem}
  .overlay{position:fixed;inset:0;background:rgba(6,8,12,.75);backdrop-filter:blur(6px);display:none;align-items:center;justify-content:center;z-index:30}
  .dialog{background:#0f1621;border:1px solid #253448;border-radius:16px;max-width:560px;width:92%;padding:1rem;box-shadow:0 20px 50px rgba(0,0,0,.45)}
  .dialog h3{margin:.1rem 0 .4rem}
  .sub{color:var(--muted)}
  .hint{font-size:.9rem;color:var(--muted)}
</style>
</head>
<body>
<header>
  <div class="brand">🧩 CGT • Dev L0 — Leaderboard (Mock MVP)</div>
  <div class="hud">
    <div class="pill">Block <strong id="blkIdx">1</strong>/3</div>
    <div class="pill">Time left <strong id="blkLeft">00:00</strong></div>
    <div class="pill">Score <strong id="score">0</strong></div>
    <div class="pill">Streak <strong id="streak">0</strong></div>
  </div>
</header>

<main>
  <section class="card">
    <div class="title">Incoming event</div>
    <div class="kv" id="kv"></div>
    <div class="hint" style="margin:.6rem 0 .3rem">Shortcuts: ✅ Accept (A) • ⛔ Reject (R)</div>
    <div class="actions">
      <button class="btn primary" id="btnAccept">✅ Current Block</button>
      <button class="btn danger" id="btnReject">⛔ Reject</button>
    </div>
  </section>

  <section class="card">
    <div class="title">Live Leaderboard (Top 5)</div>
    <table class="lb" id="lb">
      <thead><tr><th>#</th><th>Wallet</th><th>Score</th><th>Submitted</th><th>Error</th></tr></thead>
      <tbody></tbody>
    </table>
    <div class="hint">Goal: fill the leaderboard with clean entries during each live block window. Red rows hurt integrity & score; blue rows are informational.</div>
  </section>

  <section class="row" style="justify-content:space-between">
    <button class="btn ghost" id="restart">↻ Restart</button>
    <button class="btn" id="export" title="Shown again on results screen">📤 Export run</button>
  </section>
</main>

<!-- Difficulty / Rules -->
<div class="overlay" id="diff">
  <div class="dialog">
    <h3>Choose difficulty</h3>
    <div class="sub" style="margin-bottom:.6rem">
      Blocks use <b>real time</b>. Fill each leaderboard with clean entries.
      <br>Wrong or late entries still show (as red) to expose integrity issues.
    </div>
    <div class="row" style="margin-bottom:.6rem">
      <button class="btn primary" data-diff="practice">🟢 Practice</button>
      <button class="btn primary" data-diff="standard">🟡 Standard</button>
      <button class="btn primary" data-diff="pro">🔴 Pro</button>
    </div>
    <div class="row">
      <button class="btn" id="musicToggle">Music: On</button>
      <button class="btn" id="sfxToggle">SFX: On</button>
    </div>
    <div class="sub" style="margin-top:.6rem">
      Rules: accept only scores inside the live window; duplicates for the same wallet should be rejected; sort by
      <b>score desc</b>, tiebreaker <b>submittedAt asc</b>. Filling the table early ends the block.
    </div>
  </div>
</div>

<!-- Results -->
<div class="overlay" id="results">
  <div class="dialog">
    <h3 id="resTitle">Run complete</h3>
    <div class="sub" id="resBody">—</div>
    <div class="row" style="margin-top:.6rem">
      <button class="btn primary" id="playAgain">Play again</button>
      <button class="btn" id="export2">📤 Export run</button>
    </div>
  </div>
</div>

<!-- Audio -->
<audio id="bgm" loop preload="auto"
  src="https://raw.githubusercontent.com/cryptogamingtoken/cgt-games/main/sandbox/assets/Xdeviruchi%20-%208-Bit%20Fantasy%20Adventure%20Music%20(64%20KBps).mp3"></audio>

<script>
/* ------- Config ------- */
const BLOCK_SLOTS = 5;
const DIFF = { practice: 5*60, standard: 3*60, pro: 2*60 }; // seconds per block
const STREAM_RATE_MS = 900;
const ACCEPT_POINTS = 3, RED_PENALTY = -2, BLUE_NOTE = 0;

let difficulty = 'pro';
let sfxOn = true, musicOn = true;

/* ------- State ------- */
let blockIdx = 0, blockEndAt = 0, timer=null;
let score=0, streak=0;
let rows = [];
let incoming = null;
let runLog = [];
let audioUnlocked=false;

/* ------- DOM ------- */
const diff = document.getElementById('diff');
const results = document.getElementById('results');
const blkLeft = document.getElementById('blkLeft');
const blkIdxEl = document.getElementById('blkIdx');
const scoreEl = document.getElementById('score');
const streakEl = document.getElementById('streak');
const kv = document.getElementById('kv');
const lbBody = document.querySelector('#lb tbody');
const btnAccept = document.getElementById('btnAccept');
const btnReject = document.getElementById('btnReject');
const restart = document.getElementById('restart');
const exportBtn = document.getElementById('export');
const exportBtn2 = document.getElementById('export2');
const playAgain = document.getElementById('playAgain');
const sfxBtn = document.getElementById('sfxToggle');
const musicBtn = document.getElementById('musicToggle');
const bgm = document.getElementById('bgm');

/* ------- Audio (WebAudio SFX) ------- */
let ctx;
function ensureAudio(){
  try{
    if(!ctx) ctx = new (window.AudioContext||window.webkitAudioContext)();
    if(ctx.state==='suspended') ctx.resume();
    if(musicOn && !audioUnlocked){ bgm.volume=.35; bgm.play().catch(()=>{}); audioUnlocked=true; }
  }catch(e){}
}
function blip(freq=880, dur=0.07, vol=0.08){
  if(!sfxOn) return;
  try{
    ensureAudio(); if(!ctx||ctx.state!=='running') return;
    const o=ctx.createOscillator(), g=ctx.createGain();
    o.type='sine'; o.frequency.value=freq; g.gain.value=vol;
    o.connect(g); g.connect(ctx.destination); o.start();
    setTimeout(()=>o.stop(), dur*1000);
  }catch(e){}
}
function thunk(){ blip(220,0.06,0.09); }
function ding(){ blip(980,0.08,0.09); setTimeout(()=>blip(1280,0.1,0.08),100); }

/* ------- Utils ------- */
const rand = (min,max)=>Math.floor(Math.random()*(max-min+1))+min;
const pad = n=>String(n).padStart(2,'0');
function nowStr(){ const d=new Date(); return `${pad(d.getHours())}:${pad(d.getMinutes())}:${pad(d.getSeconds())}`;}
function fmtLeft(sec){ sec=Math.max(0,sec); const m=Math.floor(sec/60), s=sec%60; return `${pad(m)}:${pad(s)}`; }
function toast(msg){
  const t=document.createElement('div');
  t.textContent=msg; t.style.position='fixed'; t.style.left='50%'; t.style.bottom='18px';
  t.style.transform='translateX(-50%)'; t.style.background='#101722';
  t.style.border='1px solid #263448'; t.style.borderRadius='10px';
  t.style.padding='.55rem .75rem'; t.style.zIndex='99'; t.style.color='var(--ink)';
  t.style.boxShadow='0 10px 24px rgba(0,0,0,.35)';
  document.body.appendChild(t); setTimeout(()=>t.remove(),1400);
}

/* ------- Event generator ------- */
function genEvent(){
  const wallet = 'W'+rand(1,6);
  const score = rand(400,1400);
  const submittedAt = nowStr();
  const r = Math.random();
  let flags = 'ok';
  if(r<0.12) flags='duplicate';
  else if(r<0.22) flags='outsideWindow';
  else if(r<0.28) flags='spoof';
  else if(r<0.36) flags='tiebreakerCase';
  return {
    id: 'e'+Date.now()+rand(10,99),
    wallet, score, submittedAt, flags,
    block: 'B'+(blockIdx+1)
  };
}

/* ------- Rendering ------- */
function renderIncoming(ev){
  kv.innerHTML = `
    <div class="k">ID</div><div>${ev.id}</div>
    <div class="k">Wallet</div><div>${ev.wallet}</div>
    <div class="k">Score</div><div>${ev.score}</div>
    <div class="k">Submitted</div><div>${ev.submittedAt}</div>
    <div class="k">Block</div><div>${ev.block}</div>
    <div class="k">Flags</div><div>${ev.flags}</div>
  `;
}
function renderLB(){
  lbBody.innerHTML='';
  rows
   .sort((a,b)=> b.score - a.score || (a.submittedAt.localeCompare(b.submittedAt)))
   .slice(0,BLOCK_SLOTS)
   .forEach((r,i)=>{
      const tr=document.createElement('tr');
      const cls = r.error==='ok' ? 'ok' : (r.error==='info'?'warn':'bad');
      tr.innerHTML = `<td>${i+1}</td><td>${r.wallet}</td><td>${r.score}</td><td>${r.submittedAt}</td>
        <td class="${cls}">${r.error==='ok'?'—':r.errorMsg||r.error}</td>`;
      lbBody.appendChild(tr);
   });
}

/* ------- Accept / Reject ------- */
function decideError(ev, accepting){
  if(Date.now() > blockEndAt) return {error:'bad', msg:'outside window'};
  const dup = rows.find(r=>r.wallet===ev.wallet);
  if(dup){
    return accepting ? {error:'bad', msg:'duplicate wallet'} : {error:'info', msg:'duplicate'};
  }
  if(accepting && (ev.flags==='outsideWindow' || ev.flags==='spoof')) {
    return {error:'bad', msg:ev.flags};
  }
  if(ev.flags==='tiebreakerCase') return {error:accepting?'ok':'info', msg:'tiebreaker'};
  return {error: accepting ? 'ok' : 'info', msg: accepting ? '' : 'rejected'};
}

function accept(){
  if(!incoming) return;
  const {error,msg}=decideError(incoming,true);
  rows.push({...incoming, error:error, errorMsg:msg});
  if(error==='ok'){ score+=ACCEPT_POINTS; streak++; ding(); }
  else { score+=RED_PENALTY; streak=0; thunk(); }
  scoreEl.textContent=score; streakEl.textContent=streak;
  renderLB();
  incoming = genEvent(); renderIncoming(incoming);
  checkBlockEnd();
}
function reject(){
  if(!incoming) return;
  const {error,msg}=decideError(incoming,false);
  const mapped = (error==='info'?'info':'bad');
  rows.push({...incoming, error:mapped, errorMsg:msg||'rejected'});
  score += (mapped==='bad'? RED_PENALTY : BLUE_NOTE);
  streak=0; thunk();
  scoreEl.textContent=score; streakEl.textContent=streak;
  renderLB();
  incoming = genEvent(); renderIncoming(incoming);
  checkBlockEnd();
}

/* ------- Block & Run control ------- */
function checkBlockEnd(){
  if(rows.length >= BLOCK_SLOTS){ endBlock('filled'); }
}
function endBlock(reason){
  clearInterval(timer);
  const acceptedClean = rows.filter(r=>r.error==='ok').length;
  runLog.push({block:blockIdx+1, reason, acceptedClean, rows:rows.slice()});
  blockIdx++;
  if(blockIdx>=3){ endRun(); }
  else { startBlock(); }
}
function endRun(){
  clearInterval(timer);
  const clean = runLog.reduce((a,b)=>a+b.acceptedClean,0);
  let title, band;
  if(clean<=5)       { title='⭐ Sloppy Developer'; band='Needs stricter windowing & dup handling.'; }
  else if(clean<=9)  { title='⭐⭐ Solid Developer'; band='Good routing, a few integrity leaks.'; }
  else               { title='⭐⭐⭐ Core Developer'; band='Strong windowing, clean tables.'; }
  document.getElementById('resTitle').textContent=title;
  document.getElementById('resBody').innerHTML =
    `Blocks: <b>${runLog.length}</b> • Clean rows: <b>${clean}</b> • Score: <b>${score}</b><br><span class="sub">${band}</span>`;
  results.style.display='flex';
}
function startBlock(){
  rows = [];
  blkIdxEl.textContent = (blockIdx+1);
  const dur = DIFF[difficulty] || DIFF.pro;
  blockEndAt = Date.now() + dur*1000;
  renderLB();
  incoming = genEvent(); renderIncoming(incoming);

  clearInterval(timer);
  timer = setInterval(()=>{
    const left = Math.max(0, Math.floor((blockEndAt - Date.now())/1000));
    blkLeft.textContent = fmtLeft(left);
    if(left<=0){ endBlock('timeout'); }
  }, 250);

  if(window._stream){ clearInterval(window._stream); }
  window._stream = setInterval(()=>{
    if(Math.random()<0.35){ incoming = genEvent(); renderIncoming(incoming); }
  }, STREAM_RATE_MS);
}

/* ------- Difficulty / boot ------- */
function showDiff(){ diff.style.display='flex'; }
function hideDiff(){ diff.style.display='none'; }
function restartAll(){ clearInterval(timer); blockIdx=0; score=0; streak=0; scoreEl.textContent=0; streakEl.textContent=0; showDiff(); }

document.querySelectorAll('[data-diff]').forEach(b=>{
  b.addEventListener('click', ()=>{
    difficulty = b.dataset.diff;
    hideDiff();
    ensureAudio();
    startBlock();
  });
});
sfxBtn.addEventListener('click',()=>{ sfxOn=!sfxOn; sfxBtn.textContent=`SFX: ${sfxOn?'On':'Off'}`; if(sfxOn) blip(); });
musicBtn.addEventListener('click',()=>{
  musicOn=!musicOn; musicBtn.textContent=`Music: ${musicOn?'On':'Off'}`;
  if(musicOn){ ensureAudio(); bgm.volume=.35; bgm.play().catch(()=>{}); } else bgm.pause();
});

btnAccept.addEventListener('click',()=>{ ensureAudio(); accept(); });
btnReject.addEventListener('click',()=>{ ensureAudio(); reject(); });
restart.addEventListener('click',()=>{ ensureAudio(); results.style.display='none'; restartAll(); });
playAgain.addEventListener('click',()=>{ ensureAudio(); results.style.display='none'; restartAll(); });

document.addEventListener('keydown',e=>{
  if(e.key==='a' || e.key==='A') accept();
  if(e.key==='r' || e.key==='R') reject();
});

/* ------- Export ------- */
function exportRun(){
  const payload={
    game:"Dev L0 — Leaderboard (Mock MVP)",
    difficulty, score, streak,
    blocks: runLog,
    timestamp:new Date().toISOString()
  };
  const text=JSON.stringify(payload,null,2);
  navigator.clipboard.writeText(text).then(()=>toast("Run exported ✅")).catch(()=>{console.log(text);toast("Copy failed. See console.");});
}
exportBtn.addEventListener('click', exportRun);
exportBtn2.addEventListener('click', exportRun);

/* ------- iOS audio unlock ------- */
['pointerdown','touchstart','click'].forEach(ev=>{
  document.addEventListener(ev, ()=>{ ensureAudio(); }, { once:true, passive:true });
});

/* boot */
showDiff();
</script>
</body>
</html>
